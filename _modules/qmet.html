<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>qmet &#8212; qMET: Quality Assurance in Metabolomics 0.1.2 documentation</title>
    
    <link rel="stylesheet" href="../_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body role="document">
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="../index.html">qMET: Quality Assurance in Metabolomics 0.1.2 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for qmet</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span> 
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="c1">#matplotlib.rcParams[&#39;text.usetex&#39;] = True</span>
<span class="c1">#matplotlib.use(&#39;Agg&#39;)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">decomposition</span> <span class="k">as</span> <span class="n">skdecomp</span>

<span class="n">take_log</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">idfunc</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">arg</span>

<span class="k">def</span> <span class="nf">fanndataread</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads and normalizes a set of vector data in the file specified by filename</span>
<span class="sd">    </span>
<span class="sd">    The datafile is assumed to be in the format from the Fast Artificial Neural Network Library. This format is:</span>
<span class="sd">     * One line that specifies the number of samples, the number of features in a sample, and the number of classes</span>
<span class="sd">     * Two lines per sample</span>
<span class="sd">     ** The feature vector for that sample</span>
<span class="sd">     ** The class vector for that sample</span>
<span class="sd">    </span>
<span class="sd">    Returns: </span>
<span class="sd">     * featuredata, an array of the feature data</span>
<span class="sd">     * classdata, an array of the class identifications</span>
<span class="sd">     * fileinfo, an array containing the number of samples, the number of features, and the number of classes</span>
<span class="sd">    </span>
<span class="sd">    :param filename: The file from which the neural network data are to be read</span>
<span class="sd">    :type filename: str    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">annfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="c1"># Open the FANN-formatted data file</span>
    <span class="c1">#Read the FANN-formatted NMR file</span>
    <span class="n">annfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#Make sure we&#39;re at the beginning of the file</span>
    <span class="n">fileinfo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">annfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#Read: Number of data elements, number of bins, number of class IDs</span>
    <span class="n">featuredata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">fileinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fileinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1">#Build the empty anndata array</span>
    <span class="n">classdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">fileinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fileinfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">fileinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">):</span>
        <span class="n">featureline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">annfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1">#read the 1800-column ANN data line</span>
        <span class="n">classline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">annfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="c1">#this is the class data, which isn&#39;t used for a SOM</span>
        <span class="n">featuredata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">featureline</span> <span class="c1">#Load the feature data and class data into the arrays</span>
        <span class="n">classdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">classline</span>
    <span class="n">annfile</span><span class="o">.</span><span class="n">close</span>
    
    <span class="n">output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">featuredata</span><span class="p">,</span><span class="n">classes</span><span class="o">=</span><span class="n">classdata</span><span class="p">,</span><span class="n">fileinfo</span><span class="o">=</span><span class="n">fileinfo</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">_xldataread</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">sheetname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads and normalizes a set of vector data in the file specified by filename</span>
<span class="sd">    </span>
<span class="sd">    The data file is assumed to be in an Excel file, which will be read by the pandas.read_excel() function.</span>
<span class="sd">    </span>
<span class="sd">    Returns: </span>
<span class="sd">     * featuredata, an array of the feature data</span>
<span class="sd">     * classdata, an array of the class identifications</span>
<span class="sd">     * fileinfo, an array containing the number of samples, the number of features, and the number of classes</span>
<span class="sd">    </span>
<span class="sd">    :param filename: The file from which the neural network data are to be read</span>
<span class="sd">    :type filename: str    </span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">Kohonen_udistance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">Klayer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the Kohonen U-matrix for a rectangular Kohonen map</span>
<span class="sd">    </span>
<span class="sd">    :param i:</span>
<span class="sd">    :param j:</span>
<span class="sd">    :param Klayer:</span>
<span class="sd">    :type i: int</span>
<span class="sd">    :type j: int</span>
<span class="sd">    :type Klayer: Kohonen codebook vector layer of a PyMVPA self-organizing map</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uvec</span> <span class="o">=</span> <span class="n">Klayer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span> <span class="c1">#Get the Kohonen codebook vector at the current position</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Klayer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,:]</span><span class="o">-</span><span class="n">uvec</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Klayer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">uvec</span><span class="p">)</span>
    <span class="n">dxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Klayer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">uvec</span><span class="p">)</span>
    <span class="n">dyx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Klayer</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span><span class="o">-</span><span class="n">Klayer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,:])</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="p">(</span><span class="n">dxy</span> <span class="o">+</span> <span class="n">dyx</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dz</span>
<span class="k">def</span> <span class="nf">spectrumplot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">increment</span><span class="p">,</span><span class="n">vertsize</span><span class="p">,</span><span class="n">maxz</span><span class="p">,</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">xdata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;Plots a set of one-dimensional spectra as a heat map. The data are split into several heat maps to facilitate visualization</span>
<span class="sd">    </span>
<span class="sd">    :param data: The array of spectral data to be plotted</span>
<span class="sd">    :param increment: the increment that each sub map includes</span>
<span class="sd">    :param vertsize: The size of the plot in inches</span>
<span class="sd">    :param maxz: The maximum value for the heat map</span>
<span class="sd">    :param symmetric: If False or absent, then the minimum value for the heat map is 0. Otherwise it is -1*maxz</span>
<span class="sd">    :param xdata: The x values corresponding to the spectral data, if any</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_xrange</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data_xrange</span><span class="p">)</span>
    <span class="n">numplots</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">data_xrange</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">increment</span><span class="p">)))</span>
    <span class="n">mfig</span><span class="p">,</span><span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">numplots</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">vertsize</span><span class="p">))</span>
    <span class="n">vertextent</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">symmetric</span><span class="p">:</span>
        <span class="n">minz</span> <span class="o">=</span> <span class="o">-</span><span class="n">maxz</span>
        <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">colormap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span>
    
        
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xdata</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">xdata</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">increment</span><span class="p">],</span><span class="n">xdata</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">increment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">vertextent</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">increment</span><span class="p">,(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">increment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">vertextent</span><span class="p">]</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="n">i</span><span class="o">*</span><span class="n">increment</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">increment</span><span class="p">],</span>
                       <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                       <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">minz</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">maxz</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">mfig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.92</span><span class="p">,</span><span class="mf">0.12</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.78</span><span class="p">])</span>
    <span class="n">mfig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="k">return</span>
<span class="k">def</span> <span class="nf">hellinger</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the Hellinger distance between two sum-normalized vectors</span>
<span class="sd">    </span>
<span class="sd">    :param x: The first vector</span>
<span class="sd">    :param y: The second vector</span>
<span class="sd">    :type x: ndarray</span>
<span class="sd">    :type y: ndarray</span>
<span class="sd">    :returns: ``hellinger(x,y) = np.sqrt( 1 - np.dot(np.sqrt(x),np.sqrt(y)) )``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#hellinger_distance = sp.spatial.distance.euclidean(np.sqrt(x),np.sqrt(y))</span>
    <span class="n">squared_hellinger_distance</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">hellinger_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">squared_hellinger_distance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hellinger_distance</span>
<span class="k">def</span> <span class="nf">hellinger_hyp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the hyperbolic Hellinger distance metric between two vectors</span>
<span class="sd">    </span>
<span class="sd">    :param x: The first vector</span>
<span class="sd">    :param y: The second vector</span>
<span class="sd">    :type x: ndarray</span>
<span class="sd">    :type y: ndarray</span>
<span class="sd">    :returns: ``hellinger_hyp(x,y) = math.log( (1+hellinger(x,y))/(1 - hellinger(x,y)) )``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hellinger_distance</span> <span class="o">=</span> <span class="n">hellinger</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hellinger_hyperbolic_distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">hellinger_distance</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">hellinger_distance</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hellinger_distance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hellinger_hyperbolic_distance</span>
<span class="k">def</span> <span class="nf">jeffries</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the Jeffries divergence between two vectors</span>
<span class="sd">    </span>
<span class="sd">    :param x: The first vector</span>
<span class="sd">    :param y: The second vector</span>
<span class="sd">    :type x: ndarray</span>
<span class="sd">    :type y: ndarray</span>
<span class="sd">    :returns:``jeffries(x,y) = (1/2) * ( entropy(x,y) + entropy(y,x) )``</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entropy_xy</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">entropy_yx</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="n">jeffries_entropy</span> <span class="o">=</span> <span class="p">(</span><span class="n">entropy_xy</span><span class="o">+</span><span class="n">entropy_yx</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="k">return</span> <span class="n">jeffries_entropy</span>
<span class="k">def</span> <span class="nf">jensen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the Jensen-Shannon metric between two vectors</span>
<span class="sd">    </span>
<span class="sd">    :param x: The first vector</span>
<span class="sd">    :param y: The second vector</span>
<span class="sd">    :type x: ndarray</span>
<span class="sd">    :type y: ndarray</span>
<span class="sd">    :returns:``jensen(x,y) = entropy(x,m) + entropy(y,m)`` where ``m = (1/2) * (x + y)``</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">entropy_xm</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">entropy_ym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">mean</span><span class="p">)</span>
    <span class="n">jensen_entropy</span> <span class="o">=</span> <span class="p">(</span><span class="n">entropy_xm</span> <span class="o">+</span> <span class="n">entropy_ym</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">jensen_entropy</span>
<span class="k">def</span> <span class="nf">jensen_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the Jensen-Shannon distance between two vectors</span>
<span class="sd">    </span>
<span class="sd">    :param x: The first vector</span>
<span class="sd">    :param y: The second vector</span>
<span class="sd">    :type x: ndarray</span>
<span class="sd">    :type y: ndarray</span>
<span class="sd">    :returns:``jensen_distance(x,y) = sqrt(entropy(x,m) + entropy(y,m))``</span>
<span class="sd">    </span>
<span class="sd">    where ``m = (1/2) * (x + y)``</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jensen_entropy</span> <span class="o">=</span> <span class="n">jensen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">jensen_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jensen_entropy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jensen_distance</span>
<span class="k">def</span> <span class="nf">jensen_hyp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the hyperbolic Jensen-Shannon metric between two vectors</span>
<span class="sd">    </span>
<span class="sd">    :param x: The first vector</span>
<span class="sd">    :param y: The second vector</span>
<span class="sd">    :type x: ndarray</span>
<span class="sd">    :type y: ndarray</span>
<span class="sd">    :returns: ``jensen_hyp(x,y) = math.log( (1+jensen_distance(x,y))/(1 - jensen_distance(x,y)) )``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jensen_entropy</span> <span class="o">=</span> <span class="n">jensen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">jensen_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jensen_entropy</span><span class="p">)</span>
    <span class="n">jensen_hyperbolic_distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">jensen_distance</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">jensen_distance</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">jensen_hyperbolic_distance</span>
<span class="k">def</span> <span class="nf">fix_spectrum</span><span class="p">(</span><span class="n">anndata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes small values from an NMR spectrum and replaces them with an arbitrarily small value, in this case 1.0e-16</span>
<span class="sd">    </span>
<span class="sd">    :param anndata: The data to be corrected</span>
<span class="sd">    :returns: anndata_fixed, the corrected data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">anndata_fixed</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">anndata</span><span class="p">)</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">16</span>
    <span class="n">anndata_fixed</span><span class="p">[</span><span class="n">anndata</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span>
    <span class="k">return</span> <span class="n">anndata_fixed</span>
<span class="k">def</span> <span class="nf">distance_square</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
    <span class="n">distance_condensed</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">metric</span><span class="p">)</span>
    <span class="n">distance_square</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">distance_condensed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distance_square</span>
<span class="k">def</span> <span class="nf">positional_array</span><span class="p">(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">numsets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the positional array vector based on the number of laboratories in an interlab study and the number of samples measured by each laboratory</span>
<span class="sd">    </span>
<span class="sd">    :param numspecs: The number of samples contained within each data set, or the number of objects that have been measured</span>
<span class="sd">    :param numsets: The number of laboratories in the intercomparison</span>
<span class="sd">    :returns: Pos, an array identifying the first and last elements of the data set from each laboratory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">numsets</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">):</span>
        <span class="n">Pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numspecs</span><span class="p">,(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numspecs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Pos</span>
<span class="k">def</span> <span class="nf">data_reshape</span><span class="p">(</span><span class="n">data_bylab</span><span class="p">,</span><span class="n">positional_array</span><span class="p">):</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data_byspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data_bylab</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ii</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">pos_small</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">positional_array</span><span class="p">):</span>
            <span class="n">data_byspec</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numsets</span><span class="p">,:]</span><span class="o">=</span><span class="n">data_bylab</span><span class="p">[</span><span class="n">pos_small</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">data_byspec</span>
<span class="k">def</span> <span class="nf">mahalanobis_covariance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the pooled covariance matrix among spectra for use in determining the Mahalanobis distance.</span>
<span class="sd">    </span>
<span class="sd">    :param data: The data for which a Mahalanobis distance will be calculated</span>
<span class="sd">    :param positional_array: The positional array that defines how the data are aligned</span>
<span class="sd">    :param threshold: The threshold for singular values to retain in the inverse covariance matrix</span>
<span class="sd">    :type threshold: float</span>
<span class="sd">    :returns: mahalanobis_dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">covariance</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">for</span> <span class="n">spec_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">):</span>
        <span class="n">spec_array</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">spec_num</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">spec_array</span><span class="p">,:]</span>
        <span class="n">data_centered</span> <span class="o">=</span> <span class="n">data_array</span> <span class="o">-</span> <span class="n">data_array</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cov_this</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">data_centered</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">covariance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cov_this</span><span class="p">)</span>
        <span class="n">covariance</span> <span class="o">+=</span> <span class="p">(</span><span class="n">numsets</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cov_this</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">covariance</span> <span class="o">/</span> <span class="p">((</span><span class="n">numsets</span> <span class="o">*</span> <span class="n">numspecs</span><span class="p">)</span> <span class="o">-</span> <span class="n">numspecs</span><span class="p">)</span>
    <span class="n">VI</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">covariance</span><span class="p">,</span><span class="n">rcond</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
    <span class="n">significant_components</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mahalanobis_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">VI</span><span class="o">=</span><span class="n">VI</span><span class="p">,</span><span class="n">significant_components</span><span class="o">=</span><span class="n">significant_components</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mahalanobis_dict</span>
<span class="k">def</span> <span class="nf">distances</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">metric</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">mahalanobis_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the interlaboratory distances for each spectrum and interspectral distances for each laboratory</span>
<span class="sd">    Must define the inverse covariance matrix if metric=&#39;mahalanobis&#39;</span>
<span class="sd">    </span>
<span class="sd">    :param data: The array of spectral data whos distances must be calculated</span>
<span class="sd">    :param metric: The distance metric to be used for the calculation. Will be passed to scipy.spatial.distance.pdist()</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param mahalanobis_dict: A dictionary containing the inverse covariance matrix among the spectra and the list of significant comonents used to calculate that matrix. Can be calculated using qmet.mahalanobis_covariance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">VI</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">significant_components</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;mahalanobis&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">mahalanobis_dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must define the inverse covariance matrix if metric is mahalanobis&#39;</span><span class="p">)</span>
        <span class="n">VI</span><span class="o">=</span><span class="n">mahalanobis_dict</span><span class="p">[</span><span class="s1">&#39;VI&#39;</span><span class="p">]</span>
        <span class="n">significant_components</span><span class="o">=</span><span class="n">mahalanobis_dict</span><span class="p">[</span><span class="s1">&#39;significant_components&#39;</span><span class="p">]</span>
    
    
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">total_sets</span> <span class="o">=</span> <span class="n">numsets</span><span class="o">*</span><span class="n">numspecs</span><span class="c1">#positional_array[-1,-1]</span>
    
    <span class="n">distance_bylab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">total_sets</span><span class="p">,</span><span class="n">numspecs</span><span class="p">))</span>
    <span class="n">distance_byspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">total_sets</span><span class="p">,</span><span class="n">numsets</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">spec_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">):</span>
        <span class="n">spec_array</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">spec_num</span>
        <span class="c1">#print spec_array</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">spec_array</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;mahalanobis&#39;</span><span class="p">:</span>
            <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span><span class="n">significant_components</span><span class="p">]</span>
        <span class="c1">#print data_array.shape</span>
        <span class="n">distance_array</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span><span class="n">VI</span><span class="o">=</span><span class="n">VI</span><span class="p">)</span>
        <span class="n">distance_byspec</span><span class="p">[</span><span class="n">spec_num</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">spec_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">distance_array</span><span class="p">)</span>
        <span class="c1">#plt.imshow( sp.spatial.distance.squareform(distance_array), origin=&#39;lower&#39;,cmap=&#39;Greys&#39;,interpolation=&quot;none&quot;)</span>
    <span class="k">for</span> <span class="n">lab_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">):</span>
        <span class="n">spec_array</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">positional_array</span><span class="p">[</span><span class="n">lab_num</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">positional_array</span><span class="p">[</span><span class="n">lab_num</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#print spec_array</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">spec_array</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;mahalanobis&#39;</span><span class="p">:</span>
            <span class="n">data_array</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span><span class="n">significant_components</span><span class="p">]</span>
        <span class="c1">#print data_array.shape</span>
        <span class="n">distance_array</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span><span class="n">VI</span><span class="o">=</span><span class="n">VI</span><span class="p">)</span>
        <span class="n">distance_bylab</span><span class="p">[</span><span class="n">lab_num</span><span class="o">*</span><span class="n">numspecs</span><span class="p">:(</span><span class="n">lab_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numspecs</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">distance_array</span><span class="p">)</span>
    <span class="c1">#raise ValueError</span>
    <span class="k">return</span> <span class="n">distance_bylab</span><span class="p">,</span><span class="n">distance_byspec</span>
<span class="k">def</span> <span class="nf">distance_measure_fig</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">sets_to_plot</span><span class="p">,</span>
                         <span class="n">distance_matrix_list</span><span class="p">,</span><span class="n">distance_labels</span><span class="p">,</span><span class="n">lab_labels</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span><span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the plot of the distance measure figure, which will plot all of the samples corresponding to a given sample label and the interspectral distances</span>
<span class="sd">    </span>
<span class="sd">    :param xdata: The x-data labels corresponding to the spectral data</span>
<span class="sd">    :param ydata: The spectral data</span>
<span class="sd">    :param positional_array: The positional array describing how to find the spectral data in ydata that correspond to particular sample labels</span>
<span class="sd">    :param Spectrum_names: The names attached to the sample labels. This will be written on each row</span>
<span class="sd">    :param sets_to_plot: An iterable of integers describing which sample labels will be plotted</span>
<span class="sd">    :param distance_matrix_list: The list of distance matrices for which heat maps will be plotted</span>
<span class="sd">    :param distance_labels: The names of the distance metrics, which will be plotted in the header</span>
<span class="sd">    :param lab_labels: The names of the laboratories or data sets in the study</span>
<span class="sd">    :key cmap: The color map that will be used for the distance heat maps</span>
<span class="sd">    :key linecolor: The line color that will be used for the spectral data</span>
<span class="sd">    :returns: sfig, the distance measure figure matplotlib object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numdist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">distance_matrix_list</span> <span class="p">)</span>

    
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">numrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets_to_plot</span><span class="p">)</span>
    <span class="c1">#print numrows</span>
    
    <span class="c1">#numspecs = 1</span>
    
    <span class="n">spectrum_width</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">distance_width</span> <span class="o">=</span> <span class="mf">1.25</span>
    
    <span class="n">height</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">label_buffer</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">title_buffer</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">numrows_eff</span> <span class="o">=</span> <span class="n">numrows</span> <span class="o">+</span> <span class="n">label_buffer</span> <span class="o">+</span> <span class="n">title_buffer</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">numdist</span><span class="o">*</span><span class="n">distance_width</span> <span class="o">+</span> <span class="n">spectrum_width</span> <span class="o">+</span> <span class="n">label_buffer</span><span class="p">)</span>
    <span class="c1">#total_height = height * (numrows_eff + 0.2)</span>
    <span class="n">total_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">numrows_eff</span><span class="p">)</span>
    <span class="c1">#sfig = plt.figure(figsize=(width,total_height))</span>
    
    <span class="c1">#sfig = plt.figure(figsize=(width,height * numrows + 1.25))</span>
       
    
    <span class="c1">#</span>
    <span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="n">spectrum_width</span><span class="p">]</span>
    <span class="n">total_width</span> <span class="o">=</span> <span class="n">spectrum_width</span>
    <span class="n">numcols</span> <span class="o">=</span> <span class="n">numdist</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1">#numcols = 2*numdist + 1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numdist</span><span class="p">):</span>
        <span class="n">widths</span> <span class="o">+=</span> <span class="p">[</span><span class="n">distance_width</span><span class="p">]</span><span class="c1">#,0.2] # Add the appropriate number of columns to the width list</span>
        <span class="n">total_width</span> <span class="o">+=</span> <span class="n">distance_width</span><span class="c1">#+0.2</span>
    
    <span class="n">gs_key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">width_ratios</span><span class="o">=</span><span class="n">widths</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.075</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="n">sfig</span><span class="p">,</span><span class="n">sfig_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">numrows</span><span class="p">,</span><span class="n">numcols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">total_height</span><span class="p">),</span><span class="n">gridspec_kw</span><span class="o">=</span><span class="n">gs_key</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">numrows</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="n">sfig_axes</span> <span class="o">=</span> <span class="n">sfig_axes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    
    <span class="n">grids</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">numrows</span><span class="p">,</span><span class="n">numcols</span><span class="p">,</span><span class="n">width_ratios</span> <span class="o">=</span> <span class="n">widths</span><span class="p">)</span>
    
    <span class="c1">#axlist = np.array([plt.subplot(grids[0])])</span>
    <span class="c1">#for i in range(numdist):</span>
    <span class="c1">#    ax = np.array([plt.subplot(grids[i+1])])</span>
    <span class="c1">#    axlist = np.concatenate((axlist,ax))</span>
    
    <span class="n">ticks_master</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">])</span>
    <span class="c1">#ticks_master = np.array([0,0.5,1.0])</span>
    
    <span class="c1">#for spec_num in range(numspecs):</span>
    <span class="k">for</span> <span class="n">plot_num</span><span class="p">,</span><span class="n">spec_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets_to_plot</span><span class="p">):</span>
        
        <span class="c1">#ax0 = plt.subplot2grid( (numrows_eff,numdist + spectrum_width), (plot_num,0),colspan = spectrum_width)</span>
        
        <span class="c1">#ax0 = plt.subplot(grids[numcols*plot_num])</span>
        <span class="n">ax0</span> <span class="o">=</span> <span class="n">sfig_axes</span><span class="p">[</span><span class="n">plot_num</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1">#ax0 = axlist[0]</span>
        <span class="n">spec_array</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">spec_num</span>
        <span class="n">pl0</span> <span class="o">=</span> <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">spec_array</span><span class="p">,:])</span><span class="o">*</span><span class="mi">35</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span><span class="o">-</span><span class="mf">0.5</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                       <span class="p">,</span><span class="n">linecolor</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">numsets</span><span class="o">-</span><span class="mf">0.5</span><span class="p">])</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span><span class="n">numsets</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">[</span><span class="n">spec_num</span><span class="p">][:</span><span class="mi">3</span><span class="p">],</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                 <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        
        <span class="n">log_base</span> <span class="o">=</span> <span class="mf">1.01</span>

        <span class="k">for</span> <span class="n">dist_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numdist</span><span class="p">):</span>
            <span class="c1">#ax = axlist[dist_num+1]</span>
            <span class="c1">#ax = plt.subplot(grids[numcols*plot_num + dist_num + 1])</span>
            <span class="n">col_num</span> <span class="o">=</span> <span class="n">dist_num</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1">#col_num = 2*dist_num+1</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">sfig_axes</span><span class="p">[</span><span class="n">plot_num</span><span class="p">,</span><span class="n">col_num</span><span class="p">]</span>
            <span class="c1">#ax = plt.subplot2grid( (numrows_eff,numdist + spectrum_width), (plot_num,spectrum_width + dist_num))</span>
            
            <span class="n">distance_matrix</span> <span class="o">=</span> <span class="n">distance_matrix_list</span><span class="p">[</span><span class="n">dist_num</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">distance_labels</span><span class="p">[</span><span class="n">dist_num</span><span class="p">]</span>
            <span class="c1">#vmax = vmax_list[dist_num]</span>
            
            <span class="n">datarray</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">[</span><span class="n">spec_num</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">spec_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">,:]</span>
            <span class="n">data_max</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">log_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_max</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">decimals_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">log_max</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">significance_max</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_max</span>
            <span class="n">distance_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_max</span> <span class="o">*</span> <span class="n">significance_max</span><span class="p">)</span><span class="o">/</span><span class="n">significance_max</span>
            
            <span class="n">data_min</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">[</span><span class="n">distance_matrix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">log_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">decimals_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">log_min</span><span class="p">))</span>
            <span class="n">significance_min</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_min</span>
            <span class="n">distance_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">data_min</span> <span class="o">*</span> <span class="n">significance_min</span><span class="p">)</span><span class="o">/</span><span class="n">significance_min</span>
            
            <span class="c1">#distance_max = math.ceil(math.pow(log_base,math.ceil(math.log(distance_matrix.max()*1000,log_base))))/1000</span>
            <span class="c1">#distance_min = math.floor(math.pow(log_base,math.floor(math.log(distance_matrix[distance_matrix &gt; 0].min()*100,log_base))))/100</span>
            
            <span class="c1">#pl = ax.imshow(datarray,origin=&#39;lower&#39;,cmap=&#39;Greys&#39;,interpolation=&quot;none&quot;,vmin=0,vmax=vmax)</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">datarray</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">distance_min</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">distance_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">plot_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">numrows</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">ticks_master</span><span class="p">[</span><span class="n">ticks_master</span> <span class="o">&lt;=</span> <span class="n">distance_max</span><span class="p">]</span>
            <span class="c1">#print ticks</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">distance_max</span> <span class="o">&gt;</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">ticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ticks</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">distance_max</span><span class="p">])))</span><span class="c1">#[math.floor(distance_max)])))</span>
            <span class="c1">#ticks = np.array([distance_min,distance_max])</span>
            <span class="c1">#cax = sfig_axes[plot_num,col_num+1]</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">sfig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">ticks</span><span class="o">=</span><span class="n">ticks</span><span class="p">,</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">ax0_textlabel</span> <span class="o">=</span> <span class="s1">r&#39;Frequency shift / 10$^{-6}$ (ppm)&#39;</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">ax0_textlabel</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">xticks</span> <span class="o">=</span> <span class="n">ax0</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()</span><span class="c1"># * -1.0</span>
    <span class="n">xticks_string</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%2.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">xtick</span> <span class="k">for</span> <span class="n">xtick</span> <span class="ow">in</span> <span class="n">xticks</span><span class="p">]</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks_string</span><span class="p">)</span>
    
    <span class="n">y_axis_label_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">label_buffer</span> <span class="o">+</span> <span class="n">numrows</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">numrows_eff</span><span class="p">)</span>
    
    <span class="n">pairwise_distance_label</span> <span class="o">=</span> <span class="s1">r&#39;Pairwise Distance, $D_{ij,k}$&#39;</span>
    <span class="k">if</span> <span class="n">numrows</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="n">pairwise_distance_label</span> <span class="o">=</span> <span class="s1">u&#39;Pairwise</span><span class="se">\n</span><span class="s1">Distance, $D_{ij,k}$&#39;</span>
    
    <span class="n">sfig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">y_axis_label_position</span><span class="p">,</span><span class="s1">&#39;Data set ID&#39;</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">sfig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">y_axis_label_position</span><span class="p">,</span><span class="n">pairwise_distance_label</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="n">buffer_in_left</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="n">buffer_in_right</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">buffer_in_left</span>
    
    <span class="n">lab_title_x_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">spectrum_width</span> <span class="o">+</span> <span class="n">buffer_in_left</span><span class="o">*</span><span class="n">label_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">numdist</span><span class="o">*</span><span class="n">distance_width</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">spectrum_width</span> <span class="o">+</span> <span class="n">numdist</span><span class="o">*</span><span class="n">distance_width</span> <span class="o">+</span> <span class="n">label_buffer</span><span class="p">)</span>
    <span class="n">lab_title_y_position</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">#label_buffer/(2.0*numrows_eff)</span>
    <span class="c1">#print(lab_title_y_position)</span>
    <span class="c1">#print(lab_title_y_position*2)</span>
    <span class="n">spectrum_title_x_position</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">spectrum_width</span> <span class="o">+</span> <span class="n">numdist</span><span class="p">)</span>
    <span class="c1">#print lab_title_y_position</span>
    <span class="c1">#lab title = </span>
    <span class="c1">#sfig.text(lab_title_x_position,lab_title_y_position,&#39;Data set ID&#39;,ha=&#39;center&#39;,va=&#39;bottom&#39;,size=15)</span>
    <span class="n">sfig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lab_title_x_position</span><span class="p">,</span><span class="n">lab_title_y_position</span><span class="p">,</span><span class="s1">&#39;Data set ID&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#sfig.text(lab_title_x_position,0.0,&#39;Data set ID&#39;,ha=&#39;center&#39;,va=&#39;center&#39;,size=15)</span>
    <span class="c1">#sfig.text(lab_title_x_position,0.0,&#39;Data set ID&#39;,ha=&#39;center&#39;,va=&#39;center&#39;,size=15)</span>
    <span class="c1">#sfig.text(spectrum_title_x_position,0.0,ax0_textlabel,ha=&#39;center&#39;,va=&#39;center&#39;,size=15)</span>
    
    <span class="c1">#for dist_num in range(numdist):</span>
    <span class="c1">#    metric_x_position = </span>
    

    
    <span class="c1">#sfig.savefig(&#39;distances_fig.png&#39;,bbox_inches=&#39;tight&#39;,facecolor=[0,0,0,0])</span>
    <span class="c1">#sfig.tight_layout()</span>
    
    <span class="c1">#Adjust the subplot margins manually instead of using tight_layout() to do it, because the results of tight_layout() are unpredictable and ofthen don&#39;t play nicely with </span>
    
    <span class="n">left_buffer</span> <span class="o">=</span> <span class="n">buffer_in_left</span><span class="o">*</span><span class="n">label_buffer</span><span class="o">/</span><span class="p">(</span><span class="n">spectrum_width</span> <span class="o">+</span> <span class="n">numdist</span> <span class="o">+</span> <span class="n">label_buffer</span><span class="p">)</span>
    <span class="n">right_buffer</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">buffer_in_right</span><span class="o">*</span><span class="n">label_buffer</span><span class="o">/</span><span class="p">(</span><span class="n">spectrum_width</span> <span class="o">+</span> <span class="n">numdist</span> <span class="o">+</span> <span class="n">label_buffer</span><span class="p">)</span>
    <span class="n">bottom_buffer</span> <span class="o">=</span> <span class="n">label_buffer</span><span class="o">/</span><span class="p">(</span><span class="n">numrows_eff</span><span class="p">)</span>
    <span class="n">top_buffer</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">title_buffer</span><span class="o">/</span><span class="p">(</span><span class="n">numrows_eff</span><span class="p">)</span>
    <span class="n">sfig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">left_buffer</span><span class="p">,</span>
                         <span class="n">right</span><span class="o">=</span><span class="n">right_buffer</span><span class="p">,</span>
                         <span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                         <span class="n">bottom</span><span class="o">=</span><span class="n">bottom_buffer</span><span class="p">,</span>
                         <span class="n">top</span><span class="o">=</span><span class="n">top_buffer</span><span class="p">)</span>
    
    <span class="c1">#This section is for plotting various markers on the plot in order to get the proportions right. It should not be used for production figures</span>
    
    <span class="c1">#ypos_fig_boundaries = -1/4.0 * 1.0/total_height</span>
    <span class="c1">#ypos_fig_bdy_inches = -1/2.0 * 1.0/total_height</span>
    
    <span class="c1">#sfig.text(left_buffer,ypos_fig_boundaries,&#39;0.0&#39;,ha=&#39;center&#39;,va=&#39;center&#39;,size=10)</span>
    <span class="c1">#sfig.text(left_buffer,ypos_fig_bdy_inches,&#39;{:4.2f}&#39;.format(left_buffer*width),ha=&#39;center&#39;,va=&#39;center&#39;,size=10)</span>
    <span class="c1">#this_length = 0</span>
    <span class="c1">#for this_loc in widths:</span>
    <span class="c1">#    this_length += this_loc/total_width</span>
    <span class="c1">#    xpos = (this_length * right_buffer) + ((1-this_length) * left_buffer)</span>
    <span class="c1">#    sfig.text(xpos,ypos_fig_boundaries,&#39;{:4.2f}&#39;.format(this_length),ha=&#39;center&#39;,va=&#39;center&#39;,size=10)</span>
    <span class="c1">#    sfig.text(xpos,ypos_fig_bdy_inches,&#39;{:4.2f}&#39;.format(xpos*width),ha=&#39;center&#39;,va=&#39;center&#39;,size=10)</span>
    <span class="c1">#</span>
    <span class="c1">#for point in np.linspace(0,1,11):</span>
    <span class="c1">#    x_point_pos = (point * right_buffer) + ((1-point) * left_buffer)</span>
    <span class="c1">#    sfig.text(x_point_pos,0,str(point),ha=&#39;center&#39;,va=&#39;center&#39;,size=10)</span>
    <span class="c1">#    #sfig.text(point,0,str(point),ha=&#39;center&#39;,va=&#39;center&#39;,size=10)</span>
    <span class="c1">#    y_label_pos = (point*top_buffer + (1-point)*bottom_buffer)</span>
    <span class="c1">#    #sfig.text(0,y_label_pos,str(point),ha=&#39;center&#39;,va=&#39;center&#39;,size=10)</span>
    <span class="k">return</span> <span class="n">sfig</span>
<span class="k">def</span> <span class="nf">lognormal_integral</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">erfarg</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">scale</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">lognorm_int</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">erfarg</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">lognorm_int</span>
<span class="k">def</span> <span class="nf">lognormal_z</span><span class="p">(</span><span class="n">probability</span><span class="p">):</span>
    <span class="n">erfarg</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">probability</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erfinv</span><span class="p">(</span><span class="n">erfarg</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">z</span>
<span class="k">def</span> <span class="nf">get_zscores</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">distribution</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the Z scores among distances based on a lognormal distribution</span>
<span class="sd">    </span>
<span class="sd">    :param distance_matrix: The distance matrix for which the Z scores will be calculated</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param distribution: Which distribution will be assumed when assigning Z scores to each measurement of a sample.</span>
<span class="sd">    </span>
<span class="sd">    :returns: Z scores, average interspectral distance, and the parameters of the </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">lognorm_int_big</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">distances_big</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">zscores_big</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pdf_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">):</span>
        <span class="c1">#Get the data array for this spectrun</span>
        <span class="n">datarray</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">,:]</span>
        <span class="n">distance_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">datarray</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">datarray</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="c1">#Take the sum across columns and rows</span>
        <span class="n">distance_sum</span> <span class="o">=</span> <span class="n">distance_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">numsets</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">distances_big</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_sum</span> 
        
        <span class="c1">#Fit to a lognormal distribution</span>
        <span class="n">ln_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">distance_sum</span><span class="p">)</span>
        <span class="n">dist_mean</span> <span class="o">=</span> <span class="n">ln_dist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">dist_scale</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dist_mean</span><span class="p">)</span>
        <span class="n">dist_std</span> <span class="o">=</span> <span class="n">ln_dist</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="c1">#dist_mean,loc,dist_std = distribution.fit(distance_sum,floc=0)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">distance_sum</span><span class="p">,</span><span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dist_scale</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">pdf_params</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dist_mean</span><span class="p">,</span><span class="n">dist_scale</span><span class="p">,</span><span class="n">dist_std</span><span class="p">])</span>
        
        
        <span class="n">lognorm_int</span> <span class="o">=</span> <span class="n">lognormal_integral</span><span class="p">(</span><span class="n">distance_sum</span><span class="p">,</span><span class="n">dist_std</span><span class="p">,</span><span class="n">dist_mean</span><span class="p">)</span>
        <span class="n">lognorm_z</span> <span class="o">=</span> <span class="n">lognormal_z</span><span class="p">(</span><span class="n">lognorm_int</span><span class="p">)</span>
        
        <span class="n">rv</span>  <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lognorm_int</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">distance_sum</span><span class="p">)</span>
        <span class="n">lognorm_z</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">lognorm_int</span><span class="p">)</span>
        
        <span class="n">lognorm_int_big</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">]</span> <span class="o">=</span> <span class="n">lognorm_int</span>
        <span class="n">zscores_big</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">]</span> <span class="o">=</span> <span class="n">lognorm_z</span>
               
    
    <span class="k">return</span> <span class="n">zscores_big</span><span class="p">,</span><span class="n">distances_big</span><span class="p">,</span><span class="n">pdf_params</span>
<span class="k">def</span> <span class="nf">plot_zscores</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span><span class="n">zscores</span><span class="p">,</span><span class="n">pdf_params</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">Labels</span><span class="p">,</span><span class="n">num_bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">plot_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">numcols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots the sample-level average diameter distances and the associated Z scores</span>
<span class="sd">    </span>
<span class="sd">    :param distances: The sample-level average diameter distances</span>
<span class="sd">    :param zscores: The sample-level Z scores</span>
<span class="sd">    :param pdf_params: The parameters for the distribution that the Z scores are drawn from</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param Spectrum_names: The list of sample names</span>
<span class="sd">    :param Labels: The list of laboratory identifiers </span>
<span class="sd">    :param plot_range: Which samples to plot</span>
<span class="sd">    :param num_cols: The number of columns in the plot</span>
<span class="sd">    :param metric: The metric used to calculate the interspectral distances</span>
<span class="sd">    :type plot_range: list of ints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1">#print numsets,numspecs</span>
    
    <span class="k">if</span> <span class="n">plot_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">plot_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">)</span>
    <span class="n">numplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_range</span><span class="p">)</span>
    
    <span class="c1">#numcols = 2</span>
    <span class="n">numrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">numplots</span> <span class="o">+</span> <span class="n">numcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="n">numcols</span><span class="p">))</span>
    
    <span class="n">bottomplot</span> <span class="o">=</span> <span class="n">numrows</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">jefffig</span><span class="p">,</span><span class="n">jeffax_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">numrows</span><span class="p">,</span><span class="n">numcols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">numcols</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">numrows</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">jeffax</span> <span class="o">=</span> <span class="n">jeffax_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    
    <span class="n">jefffig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="s2">r&quot;Average Diameter Distance, $\^</span><span class="si">{D}</span><span class="s2">_{i,k}$&quot;</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#jefffig.text(0.5,-0.9/numrows,&#39;Data set ID&#39;,ha=&#39;center&#39;,va=&#39;top&#39;,size=15)</span>
    <span class="n">jefffig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.00</span><span class="p">,</span><span class="s1">&#39;Data set ID&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="c1">#print 0.9/numrows</span>
    
    <span class="n">log_base</span> <span class="o">=</span> <span class="mf">1.01</span>
    
    <span class="c1">#distance_max = 2 ** math.ceil(math.log(distances.max(),2))</span>
    <span class="n">distance_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
            <span class="n">log_base</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">distances</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">log_base</span>
                <span class="p">)</span>
            <span class="p">)))</span><span class="o">/</span><span class="mi">100</span>
    <span class="c1">#distance_max = math.ceil(distances.max()/10.0)*10.0</span>
    
    <span class="c1">#distance_min = 2 ** math.floor(math.log(distances.min(),2))</span>
    <span class="n">distance_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
            <span class="n">log_base</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">distances</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">log_base</span>
                <span class="p">)</span>
            <span class="p">)))</span>
    <span class="n">data_max</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">log_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_max</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">decimals_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">log_max</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">significance_max</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_max</span>
    <span class="n">distance_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_max</span> <span class="o">*</span> <span class="n">significance_max</span><span class="p">)</span><span class="o">/</span><span class="n">significance_max</span>
    
    <span class="n">data_min</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">log_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">decimals_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">log_min</span><span class="p">))</span>
    <span class="n">significance_min</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_min</span>
    <span class="n">distance_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">data_min</span> <span class="o">*</span> <span class="n">significance_min</span><span class="p">)</span><span class="o">/</span><span class="n">significance_min</span>
    
    <span class="n">jeff_locator</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">prune</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="k">for</span> <span class="n">plot_num</span><span class="p">,</span><span class="n">spec_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_range</span><span class="p">):</span>
        <span class="n">distances_this</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">spec_num</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">spec_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">]</span>
        
        <span class="n">dist_mean</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">spec_num</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dist_scale</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">spec_num</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dist_std</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">spec_num</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">zscores_this</span> <span class="o">=</span> <span class="n">zscores</span><span class="p">[</span><span class="n">spec_num</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">spec_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">]</span>
        
        <span class="n">bar_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
        <span class="n">bar_edge</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
        <span class="n">text_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
        <span class="n">box_trans</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
        <span class="n">z_mask</span> <span class="o">=</span> <span class="n">zscores_this</span> <span class="o">&gt;</span> <span class="mi">5</span>
        <span class="k">for</span> <span class="n">int_num</span><span class="p">,</span><span class="n">z_out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z_mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">z_out</span><span class="p">:</span>
                <span class="n">bar_colors</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                <span class="n">bar_edge</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                <span class="c1">#text_colors[int_num] = &#39;r&#39;</span>
                <span class="n">box_trans</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#jeffax[plot_num].bar(np.arange(numsets)-width/2,distances_this,2*width,alpha=1,color=bar_colors)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">),</span><span class="n">distances_this</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">bar_colors</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">bar_edge</span><span class="p">)</span>
        
        <span class="n">jeffax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">distance_min</span><span class="p">,</span><span class="n">distance_max</span><span class="p">)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">jeff_locator</span><span class="p">)</span>
        <span class="n">jeff_yticks</span> <span class="o">=</span> <span class="n">jeffax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_majorticklocs</span><span class="p">()</span>
        
        <span class="n">lab_label_pos</span> <span class="o">=</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">distance_max</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">distance_min</span>
        
        <span class="n">sample_label_pos</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">distance_max</span> <span class="o">+</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">distance_min</span>
        <span class="c1">#print jeff_yticks[-1],jeff_yticks[0]</span>
        <span class="c1">#print distance_min,sample_label_pos</span>
        <span class="k">if</span> <span class="n">plot_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">jeffax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">int_num</span><span class="p">,</span><span class="n">zscore</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zscores_this</span><span class="p">):</span>
            <span class="k">if</span><span class="p">(</span><span class="n">z_mask</span><span class="p">[</span><span class="n">int_num</span><span class="p">]):</span> 
                <span class="n">label_pos</span> <span class="o">=</span> <span class="n">sample_label_pos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label_pos</span> <span class="o">=</span> <span class="n">sample_label_pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">distances_this</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">-</span> <span class="n">distance_min</span><span class="p">)</span>
            <span class="n">jeffax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">int_num</span><span class="p">,</span><span class="n">label_pos</span><span class="p">,</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">zscore</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span>
                           <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">text_colors</span><span class="p">[</span><span class="n">int_num</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                           <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">box_trans</span><span class="p">[</span><span class="n">int_num</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                          <span class="p">)</span>
            <span class="c1">#if zscore &lt; 5:</span>
            <span class="c1">#    jeffax[i].text(int_num,sample_label_pos,str(zscore)[0:4],ha=&#39;center&#39;, va=&#39;bottom&#39;,color=&quot;k&quot;,size=9)</span>
            <span class="c1">#else:</span>
            <span class="c1">#    jeffax[i].text(int_num,sample_label_pos,str(zscore)[0:4],ha=&#39;center&#39;, va=&#39;bottom&#39;,color=&quot;r&quot;,size=9)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">numsets</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numcols</span><span class="p">):</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">numsets</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c1">#jeffax[bottomplot+i*numrows].set_ylim(distance_min,distance_max)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">jeff_locator</span><span class="p">)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">Labels</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">lab_label_jeff_y_pos</span> <span class="o">=</span>  <span class="mf">0.1</span><span class="o">*</span><span class="n">distance_min</span> <span class="o">+</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">distance_max</span>
    <span class="k">for</span> <span class="n">plot_num</span><span class="p">,</span><span class="n">spec_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_range</span><span class="p">):</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">lab_label_jeff_y_pos</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">[</span><span class="n">spec_num</span><span class="p">],</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">jefffig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jefffig</span>
<span class="k">def</span> <span class="nf">plot_histograms</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span><span class="n">zscores</span><span class="p">,</span><span class="n">pdf_params</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">Labels</span><span class="p">,</span><span class="n">distribution</span><span class="p">,</span><span class="n">num_bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">plot_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">numcols</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots a histogram of the sample-level average diameter distances and the corresponding disribution function</span>
<span class="sd">    </span>
<span class="sd">    :param distances: The sample-level average diameter distances</span>
<span class="sd">    :param zscores: The sample-level Z scores</span>
<span class="sd">    :param pdf_params: The parameters for the distribution that the Z scores are drawn from</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param Spectrum_names: The list of sample names</span>
<span class="sd">    :param Labels: The list of laboratory identifiers</span>
<span class="sd">    :param distribution: The distribution assumed when assigning Z scores to each measurement of a sample.</span>
<span class="sd">    :param num_bins: The number of bins to use in the histogram</span>
<span class="sd">    :param plot_range: Which samples to plot</span>
<span class="sd">    :param num_cols: The number of columns in the plot</span>
<span class="sd">    :param metric: The metric used to calculate the interspectral distances</span>
<span class="sd">    :type plot_range: list of ints</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">plot_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">plot_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">)</span>
    <span class="n">numplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_range</span><span class="p">)</span>
    
    <span class="c1">#numcols = 2</span>
    <span class="n">numrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">numplots</span> <span class="o">+</span> <span class="n">numcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="n">numcols</span><span class="p">))</span>
    
    <span class="n">bottomplot</span> <span class="o">=</span> <span class="n">numrows</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="mi">5</span>
    
    <span class="n">pdffig</span><span class="p">,</span><span class="n">pdfax_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">numrows</span><span class="p">,</span><span class="n">numcols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">numcols</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">numrows</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pdfax</span> <span class="o">=</span> <span class="n">pdfax_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    
    <span class="n">pdffig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#pdffig.text(0.5,0.01*(numrows-1),&#39;Average Diameter Distance&#39;,ha=&#39;center&#39;,va=&#39;center&#39;,size=15)</span>
    <span class="n">pdffig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">r&#39;Average Diameter Distance, $\^</span><span class="si">{D}</span><span class="s1">_{i,k}$&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="c1">#print 0.01*(numrows-1)</span>
    
    <span class="n">log_base</span> <span class="o">=</span> <span class="mf">1.01</span>
    
    <span class="c1">#distance_max = 2 ** math.ceil(math.log(distances.max(),2))</span>
    <span class="n">distance_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
            <span class="n">log_base</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">distances</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">log_base</span>
                <span class="p">)</span>
            <span class="p">)))</span><span class="o">/</span><span class="mi">100</span>
    <span class="c1">#distance_max = math.ceil(distances.max()/10.0)*10.0</span>
    
    <span class="c1">#distance_min = 2 ** math.floor(math.log(distances.min(),2))</span>
    <span class="n">distance_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
            <span class="n">log_base</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">distances</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">log_base</span>
                <span class="p">)</span>
            <span class="p">)))</span>
    <span class="n">data_max</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">log_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_max</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">decimals_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">log_max</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">significance_max</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_max</span>
    <span class="n">distance_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_max</span> <span class="o">*</span> <span class="n">significance_max</span><span class="p">)</span><span class="o">/</span><span class="n">significance_max</span>
    
    <span class="n">data_min</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">log_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">decimals_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">log_min</span><span class="p">))</span>
    <span class="n">significance_min</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_min</span>
    <span class="n">distance_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">data_min</span> <span class="o">*</span> <span class="n">significance_min</span><span class="p">)</span><span class="o">/</span><span class="n">significance_min</span>
    
    <span class="c1">#print distance_min,distance_max</span>
    <span class="c1">#print significance_min,significance_max</span>
    
    <span class="n">max_bin</span> <span class="o">=</span> <span class="n">distance_max</span>
    <span class="n">min_bin</span> <span class="o">=</span> <span class="n">distance_min</span>
    <span class="n">binsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_bin</span> <span class="o">-</span> <span class="n">min_bin</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
    
    <span class="n">pdf_locator</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">prune</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="k">for</span> <span class="n">plot_num</span><span class="p">,</span><span class="n">spec_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_range</span><span class="p">):</span>
        <span class="n">distances_this</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">spec_num</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">spec_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">]</span>
        
        <span class="n">dist_mean</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">spec_num</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dist_scale</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">spec_num</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dist_std</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">spec_num</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">distances_this</span><span class="p">,</span><span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">hist_norm</span><span class="p">,</span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">distances_this</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">min_bin</span><span class="p">,</span><span class="n">max_bin</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#lognorm_dist = sp.stats.lognorm.pdf(bins,dist_std,scale=dist_scale)</span>
        <span class="n">lognorm_dist</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>

        <span class="n">pdfax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">lognorm_dist</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">binsize</span><span class="p">,</span><span class="n">hist_norm</span><span class="p">,</span><span class="n">binsize</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numcols</span><span class="p">):</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">distance_min</span><span class="p">,</span><span class="n">distance_max</span><span class="p">)</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">pdf_locator</span><span class="p">)</span>
    <span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">pdfax</span><span class="p">[</span><span class="n">bottomplot</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">lab_label_pdf_y_pos</span> <span class="o">=</span> <span class="mf">0.90</span><span class="o">*</span><span class="n">ymax</span> <span class="o">+</span> <span class="mf">0.10</span><span class="o">*</span><span class="n">ymin</span>
    <span class="n">lab_label_pdf_x_pos</span> <span class="o">=</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">distance_min</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">distance_max</span>
    <span class="k">for</span> <span class="n">plot_num</span><span class="p">,</span><span class="n">spec_num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_range</span><span class="p">):</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lab_label_pdf_x_pos</span><span class="p">,</span><span class="n">lab_label_pdf_y_pos</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">[</span><span class="n">spec_num</span><span class="p">],</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">pdffig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pdffig</span>
<span class="k">def</span> <span class="nf">zscore_analysis</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">Labels</span><span class="p">,</span><span class="n">num_bins</span><span class="p">):</span>
<span class="c1">#    &quot;&quot;&quot;Plots the Z scores for interlaboratory spectral distances, as well as a histogram </span>
<span class="c1">#    and the corresponding probability density function</span>
<span class="c1">#    &quot;&quot;&quot;</span>
    
    <span class="n">zscores</span><span class="p">,</span><span class="n">distances</span><span class="p">,</span><span class="n">pdf_params</span> <span class="o">=</span> <span class="n">get_zscores</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span><span class="n">positional_array</span><span class="p">)</span>
    
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">numcols</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">numrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">numspecs</span> <span class="o">+</span> <span class="n">numcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="n">numcols</span><span class="p">))</span>
    
    <span class="n">bottomplot</span> <span class="o">=</span> <span class="n">numrows</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="n">jefffig</span><span class="p">,</span><span class="n">jeffax_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">numrows</span><span class="p">,</span><span class="n">numcols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pdffig</span><span class="p">,</span><span class="n">pdfax_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">numrows</span><span class="p">,</span><span class="n">numcols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">jeffax</span> <span class="o">=</span> <span class="n">jeffax_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">pdfax</span> <span class="o">=</span> <span class="n">pdfax_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="c1">#jeffbig = jeffig.add_subplot(111)</span>
    
    <span class="n">jefffig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.07</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="s2">&quot;Average Diameter Distance&quot;</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">jefffig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span><span class="s1">&#39;Data set ID&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="c1">#jefffig.text(0,0.5,&quot;Distance Score&quot;,rotation=&#39;vertical&#39;,ha=&#39;center&#39;,va=&#39;center&#39;,size=15)</span>
    <span class="c1">#jefffig.text(0.5,0,&#39;Lab ID&#39;,ha=&#39;center&#39;,va=&#39;center&#39;,size=15)</span>
    
    <span class="n">pdffig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.07</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">pdffig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="s1">&#39;Average Diameter Distance&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="n">log_base</span> <span class="o">=</span> <span class="mf">1.01</span>
    
    <span class="c1">#distance_max = 2 ** math.ceil(math.log(distances.max(),2))</span>
    <span class="n">distance_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
            <span class="n">log_base</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">distances</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">log_base</span>
                <span class="p">)</span>
            <span class="p">)))</span><span class="o">/</span><span class="mi">10</span>
    <span class="c1">#distance_max = math.ceil(distances.max()/10.0)*10.0</span>
    
    <span class="c1">#distance_min = 2 ** math.floor(math.log(distances.min(),2))</span>
    <span class="n">distance_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span>
            <span class="n">log_base</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">distances</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">log_base</span>
                <span class="p">)</span>
            <span class="p">)))</span>
    <span class="n">data_max</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">log_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_max</span><span class="p">)</span>
    <span class="n">decimals_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">log_max</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">significance_max</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_max</span>
    <span class="n">distance_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_max</span> <span class="o">*</span> <span class="n">significance_max</span><span class="p">)</span><span class="o">/</span><span class="n">significance_max</span>
    
    <span class="n">data_min</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">log_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data_min</span><span class="p">)</span>
    <span class="n">decimals_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">log_min</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">significance_min</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals_min</span>
    <span class="n">distance_min</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">data_min</span> <span class="o">*</span> <span class="n">significance_min</span><span class="p">)</span><span class="o">/</span><span class="n">significance_min</span>
    <span class="c1">#distance_ticks = [math.floor(distance_max/3.0),math.floor(distance_max*2/3.0),distance_max-1]</span>
    
    <span class="n">max_bin</span> <span class="o">=</span> <span class="n">distance_max</span>
    <span class="n">min_bin</span> <span class="o">=</span> <span class="n">distance_min</span>
    <span class="n">binsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_bin</span> <span class="o">-</span> <span class="n">min_bin</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
    
    <span class="n">jeff_locator</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">prune</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    <span class="n">pdf_locator</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">prune</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">):</span>
        
        <span class="n">distances_this</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">]</span>
        <span class="c1">#print np.arange(numsets)-width</span>
        <span class="c1">#print distances_this</span>
        
        
        
        <span class="n">dist_mean</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dist_scale</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dist_std</span> <span class="o">=</span> <span class="n">pdf_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">zscores_this</span> <span class="o">=</span> <span class="n">zscores</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numsets</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">]</span>
        
        <span class="n">bar_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
        <span class="n">text_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
        <span class="n">box_trans</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
        <span class="n">z_mask</span> <span class="o">=</span> <span class="n">zscores_this</span> <span class="o">&gt;</span> <span class="mi">5</span>
        <span class="k">for</span> <span class="n">int_num</span><span class="p">,</span><span class="n">z_out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z_mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">z_out</span><span class="p">:</span>
                <span class="n">bar_colors</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
                <span class="n">text_colors</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                <span class="n">box_trans</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">)</span><span class="o">-</span><span class="n">width</span><span class="p">,</span><span class="n">distances_this</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">bar_colors</span><span class="p">)</span>
        
        <span class="n">jeffax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">distance_min</span><span class="p">,</span><span class="n">distance_max</span><span class="p">)</span>
        <span class="n">jeff_yticks</span> <span class="o">=</span> <span class="n">jeffax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_majorticklocs</span><span class="p">()</span>
        
        <span class="n">lab_label_pos</span> <span class="o">=</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">jeff_yticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">jeff_yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">sample_label_pos</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">jeff_yticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">jeff_yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
        <span class="k">for</span> <span class="n">int_num</span><span class="p">,</span><span class="n">zscore</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zscores_this</span><span class="p">):</span>
            <span class="n">jeffax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">int_num</span><span class="p">,</span><span class="n">sample_label_pos</span><span class="p">,</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">zscore</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span>
                           <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                           <span class="n">color</span><span class="o">=</span><span class="n">text_colors</span><span class="p">[</span><span class="n">int_num</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                           <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">box_trans</span><span class="p">[</span><span class="n">int_num</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                          <span class="p">)</span>
            <span class="c1">#if zscore &lt; 5:</span>
            <span class="c1">#    jeffax[i].text(int_num,sample_label_pos,str(zscore)[0:4],ha=&#39;center&#39;, va=&#39;bottom&#39;,color=&quot;k&quot;,size=9)</span>
            <span class="c1">#else:</span>
            <span class="c1">#    jeffax[i].text(int_num,sample_label_pos,str(zscore)[0:4],ha=&#39;center&#39;, va=&#39;bottom&#39;,color=&quot;r&quot;,size=9)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">numsets</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c1">#jeffax[i].set_yticks(distance_ticks)</span>
        <span class="n">hist_norm</span><span class="p">,</span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">distances_this</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">min_bin</span><span class="p">,</span><span class="n">max_bin</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#print hist_norm.shape</span>
        <span class="c1">#print bins[:-1].shape</span>
        <span class="n">lognorm_dist</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">dist_std</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="n">dist_scale</span><span class="p">)</span>
        <span class="c1">#hist_norm = hist/binsize / float(hist.sum())</span>
        <span class="c1">#print bins[1:]</span>
        <span class="c1">#print hist</span>
        <span class="c1">#print hist_norm</span>
        <span class="c1">#print lognorm_dist</span>
        <span class="c1">#pdfax[i].plot(bins[:-1],hist_norm,&#39;r&#39;,bins,lognorm_dist,&#39;k&#39;)</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span><span class="n">lognorm_dist</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">binsize</span><span class="p">,</span><span class="n">hist_norm</span><span class="p">,</span><span class="n">binsize</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="c1">#pdfax[i].set_yticks(pdf_yticks)</span>
        <span class="c1">#print i</span>
        <span class="c1">#print pdfax[i]</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numcols</span><span class="p">):</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">numsets</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">distance_min</span><span class="p">,</span><span class="n">distance_max</span><span class="p">)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">jeff_locator</span><span class="p">)</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">Labels</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">distance_min</span><span class="p">,</span><span class="n">distance_max</span><span class="p">)</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">bottomplot</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">numrows</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">pdf_locator</span><span class="p">)</span>
    
    
    <span class="n">pdf_yticks</span> <span class="o">=</span> <span class="n">pdfax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_majorticklocs</span><span class="p">()</span>
    <span class="n">lab_label_pdf_y_pos</span> <span class="o">=</span> <span class="mf">0.90</span><span class="o">*</span><span class="n">pdf_yticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.10</span><span class="o">*</span><span class="n">pdf_yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lab_label_pdf_x_pos</span> <span class="o">=</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">distance_min</span> <span class="o">+</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">distance_max</span>
    <span class="n">lab_label_jeff_y_pos</span> <span class="o">=</span>  <span class="mf">0.1</span><span class="o">*</span><span class="n">distance_min</span> <span class="o">+</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">distance_max</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">):</span>
        <span class="n">jeffax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">lab_label_jeff_y_pos</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">pdfax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lab_label_pdf_x_pos</span><span class="p">,</span><span class="n">lab_label_pdf_y_pos</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        

    <span class="c1">#jefffig.savefig(&#39;distance_z_scores.png&#39;,bbox_inches=&#39;tight&#39;,facecolor=[0,0,0,0])</span>
    <span class="c1">#pdffig.savefig(&#39;lognormal_pdfs.png&#39;,bbox_inches=&#39;tight&#39;,facecolor=[0,0,0,0])</span>

    <span class="k">return</span> <span class="n">zscores</span>
<span class="k">def</span> <span class="nf">zscore_principal_components</span><span class="p">(</span><span class="n">zscores</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">Labels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs principal components analysis on the Z scores.</span>
<span class="sd">    </span>
<span class="sd">    :param zscores: The sample-level Z scores</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param Spectrum_names: The list of sample names</span>
<span class="sd">    :param Labels: The list of laboratory identifiers</span>
<span class="sd">    :returns: zscorepca, the principal components within the Z score space</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">distance_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zscores</span><span class="p">,(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">numsets</span><span class="p">))</span>
    
    <span class="n">zscorepca</span> <span class="o">=</span> <span class="n">skdecomp</span><span class="o">.</span><span class="n">PCA</span><span class="p">()</span>
    <span class="n">zscorepca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">distance_scores</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="c1">#zscorepca.fit(np.log(distance_scores.T))</span>
    
    <span class="k">return</span> <span class="n">zscorepca</span>

<span class="k">def</span> <span class="nf">zscore_heatmap_plot</span><span class="p">(</span><span class="n">zscores</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">Labels</span><span class="p">):</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">distance_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zscores</span><span class="p">,(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">numsets</span><span class="p">))</span>
    
    <span class="n">plotsize</span> <span class="o">=</span> <span class="mi">8</span>
    
    <span class="c1">#Create the figure</span>
    <span class="n">distfig</span><span class="p">,</span><span class="n">distax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">plotsize</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">plotsize</span><span class="p">))</span>
    <span class="c1">#Plot the distance scores</span>
    
    <span class="n">zscore_max</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">zscores</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
    <span class="n">im</span> <span class="o">=</span> <span class="n">distax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">distance_scores</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">zscore_max</span><span class="p">)</span>
    <span class="n">distbar</span> <span class="o">=</span> <span class="n">distfig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">distax</span><span class="p">)</span><span class="c1">#,orientation=&#39;horizontal&#39;)#,label=&#39;Distance Score&#39;)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span> <span class="n">Labels</span> <span class="p">)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">))</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample ID&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Data set ID&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">distbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Z Score&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distfig</span>
<span class="k">def</span> <span class="nf">zscorelog_heatmap_plot</span><span class="p">(</span><span class="n">zscores</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">Labels</span><span class="p">):</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">distance_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zscores</span><span class="p">,(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">numsets</span><span class="p">))</span>
    
    <span class="n">plotsize</span> <span class="o">=</span> <span class="mi">8</span>
    
    <span class="c1">#Create the figure</span>
    <span class="n">distfig</span><span class="p">,</span><span class="n">distax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">plotsize</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">plotsize</span><span class="p">))</span>
    <span class="c1">#Plot the distance scores</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">distax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">distance_scores</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span><span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
    <span class="n">distbar</span> <span class="o">=</span> <span class="n">distfig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">distax</span><span class="p">)</span><span class="c1">#,orientation=&#39;horizontal&#39;)#,label=&#39;Distance Score&#39;)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span> <span class="n">Labels</span> <span class="p">)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">))</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample ID&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Data set ID&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">distbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Z Score&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distfig</span>
<span class="k">def</span> <span class="nf">zscore_loadings_plot</span><span class="p">(</span><span class="n">zscorepca</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">Labels</span><span class="p">):</span>
<span class="c1">#    &quot;&quot;&quot;Plots the PCA loadings calculated using zscore_principal_components()</span>
<span class="c1">#    </span>
<span class="c1">#    :param zscorepca: The principal components calculated using zscore_principal_components()</span>
<span class="c1">#    :param positional_array: The array defining the structure of the data matrix</span>
<span class="c1">#    :param Spectrum_names: The list of sample names</span>
<span class="c1">#    :param Labels: The list of laboratory identifiers</span>
<span class="c1">#    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">plotsize</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">loadfig</span><span class="p">,</span><span class="n">loadax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">plotsize</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">plotsize</span><span class="p">))</span>
    <span class="n">PCAsign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
    <span class="c1">#Plot the principal components    </span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">loadax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="o">*</span><span class="n">PCAsign</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">loadbar</span> <span class="o">=</span> <span class="n">loadfig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">loadax</span><span class="p">)</span><span class="c1">#,orientation=&#39;horizontal&#39;)</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">numsets</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">))</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample ID&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Principal Component Number&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">loadbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Component Value&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">component_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">):</span>
        <span class="n">componentscore</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="n">component_number</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">componentscore_string</span> <span class="o">=</span> <span class="n">componentscore</span> <span class="o">+</span> <span class="s2">&quot; %&quot;</span>
        <span class="c1">#loadax.text(0,component_number,componentscore_string,ha=&#39;center&#39;,va=&#39;center&#39;,bbox=dict(facecolor=&#39;white&#39;))</span>
        <span class="n">loadax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">component_number</span><span class="p">,</span><span class="n">componentscore_string</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loadfig</span>
<span class="k">def</span> <span class="nf">zscore_principal_component_plots</span><span class="p">(</span><span class="n">zscores</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">Labels</span><span class="p">):</span>
<span class="c1">#    &quot;&quot;&quot;Performs principal components analysis on the Z scores. Plots the Z scores and principal components.</span>
<span class="c1">#    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">distance_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zscores</span><span class="p">,(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">numsets</span><span class="p">))</span>
    
    <span class="n">zscorepca</span> <span class="o">=</span> <span class="n">skdecomp</span><span class="o">.</span><span class="n">PCA</span><span class="p">()</span>
    <span class="n">zscorepca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">distance_scores</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="c1">#zscorepca.fit(np.log(distance_scores.T))</span>
    <span class="n">plotsize</span> <span class="o">=</span> <span class="mi">8</span>
    
    <span class="c1">#Create the figure</span>
    <span class="n">distfig</span><span class="p">,</span><span class="n">distax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">plotsize</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">plotsize</span><span class="p">))</span>
    <span class="n">loadfig</span><span class="p">,</span><span class="n">loadax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">plotsize</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">plotsize</span><span class="p">))</span>
    
    <span class="c1">#Plot the distance scores</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">distax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">distance_scores</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">distbar</span> <span class="o">=</span> <span class="n">distfig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">distax</span><span class="p">)</span><span class="c1">#,orientation=&#39;horizontal&#39;)#,label=&#39;Distance Score&#39;)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span> <span class="n">Labels</span> <span class="p">)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">))</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    
    <span class="n">distax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample ID&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">distax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Data set ID&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">distbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Z Score&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    
    <span class="c1">#distfig.savefig(&#39;syn_distances.png&#39;,bbox_inches=&#39;tight&#39;,facecolor=[0,0,0,0])</span>
    
    
    <span class="n">PCAsign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
    <span class="c1">#Plot the principal components    </span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">loadax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="o">*</span><span class="n">PCAsign</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">loadbar</span> <span class="o">=</span> <span class="n">loadfig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">loadax</span><span class="p">)</span><span class="c1">#,orientation=&#39;horizontal&#39;)</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">numsets</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">))</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sample ID&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Principal Component Number&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">loadbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Component Value&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">component_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numsets</span><span class="p">):</span>
        <span class="n">componentscore</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="n">component_number</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">componentscore_string</span> <span class="o">=</span> <span class="n">componentscore</span> <span class="o">+</span> <span class="s2">&quot; %&quot;</span>
        <span class="n">loadax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">component_number</span><span class="p">,</span><span class="n">componentscore_string</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">))</span>
        
    <span class="c1">#loadfig.savefig(&#39;syn_loadings.png&#39;,bbox_inches=&#39;tight&#39;,facecolor=[0,0,0,0])</span>
    <span class="k">return</span> <span class="n">zscorepca</span>
<span class="k">def</span> <span class="nf">PCAplots</span><span class="p">(</span><span class="n">zscorepca</span><span class="p">,</span><span class="n">zscores</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Labels</span><span class="p">,</span><span class="n">number_components</span><span class="p">,</span><span class="n">axis_inset_position</span><span class="p">,</span><span class="n">axis_inset_xlim</span><span class="p">,</span><span class="n">axis_inset_ylim</span><span class="p">):</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">plotsize</span> <span class="o">=</span> <span class="mi">8</span>
    
    <span class="n">PCAsign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">distance_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zscores</span><span class="p">,(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">numsets</span><span class="p">))</span>
    <span class="n">zscores_projected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="o">*</span><span class="n">PCAsign</span><span class="p">,</span><span class="n">distance_scores</span><span class="p">)</span>
    
    <span class="n">component1score</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">xaxislabel</span> <span class="o">=</span> <span class="s1">&#39;Component 1: &#39;</span> <span class="o">+</span> <span class="n">component1score</span> <span class="o">+</span> <span class="s2">&quot; %&quot;</span>
    
    <span class="k">for</span> <span class="n">component_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">number_components</span><span class="p">):</span><span class="c1">#numsets):</span>
        <span class="c1">#Create the PCA plots</span>
        <span class="c1">#print component_number</span>
        <span class="n">scorefig</span><span class="p">,</span><span class="n">scoreax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">plotsize</span><span class="p">,</span><span class="n">plotsize</span><span class="p">))</span>
        <span class="n">scoreax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">component_number</span><span class="p">,:])</span>
        
        <span class="n">componentyscore</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="n">component_number</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">yaxislabel</span> <span class="o">=</span> <span class="s1">&#39;Component &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">component_number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span>  <span class="o">+</span> <span class="n">componentyscore</span> <span class="o">+</span> <span class="s2">&quot; %&quot;</span>
        <span class="n">scoreax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xaxislabel</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">scoreax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">yaxislabel</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">scoreax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>
        
        <span class="c1">#print axis_inset_position[component_number][0]</span>
        <span class="c1">#print axis_inset_position[component_number][0] is not None</span>
        
        <span class="k">if</span> <span class="n">axis_inset_position</span><span class="p">[</span><span class="n">component_number</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span><span class="c1">#component_number &lt; 3:</span>
            <span class="n">axinset</span> <span class="o">=</span> <span class="n">scorefig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">axis_inset_position</span><span class="p">[</span><span class="n">component_number</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">axinset</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">component_number</span><span class="p">,:])</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="n">axis_inset_xlim</span><span class="p">[</span><span class="n">component_number</span><span class="p">]</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">axis_inset_ylim</span><span class="p">[</span><span class="n">component_number</span><span class="p">]</span>
            <span class="n">axinset</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">axinset</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">labeltext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">zscores_projected</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">zscores_projected</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">zscores_projected</span><span class="p">[</span><span class="n">component_number</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">zscores_projected</span><span class="p">[</span><span class="n">component_number</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">axinset</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span><span class="p">,</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">component_number</span><span class="p">,</span><span class="n">j</span><span class="p">],</span>
                                 <span class="n">labeltext</span><span class="p">,</span>
                                 <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                                 <span class="n">size</span><span class="o">=</span><span class="s1">&#39;12&#39;</span><span class="p">,</span>
                                 <span class="n">bbox</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scoreax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mf">0.3</span><span class="p">,</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">component_number</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>
                                 <span class="n">labeltext</span><span class="p">,</span>
                                 <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                                 <span class="n">size</span><span class="o">=</span><span class="s1">&#39;12&#39;</span><span class="p">,</span>
                                 <span class="n">bbox</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">labeltext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Labels</span><span class="p">):</span>
                <span class="n">scoreax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mf">0.3</span><span class="p">,</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">component_number</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>
                             <span class="n">labeltext</span><span class="p">,</span>
                             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                             <span class="n">size</span><span class="o">=</span><span class="s1">&#39;12&#39;</span><span class="p">,</span>
                             <span class="n">bbox</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;pca_component&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">component_number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span>
        <span class="n">scorefig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span>
<span class="k">def</span> <span class="nf">zscore_outliers</span><span class="p">(</span><span class="n">zscorepca</span><span class="p">,</span><span class="n">zscores</span><span class="p">,</span><span class="n">support_fraction</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">lab_labels</span><span class="p">,</span><span class="n">distribution</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param zscorepca: The principal components calculated using zscore_principal_components()</span>
<span class="sd">    :param zscores: The sample-level Z scores</span>
<span class="sd">    :param support_fraction: The fraction of samples that must be retained</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param lab_labels: The list of laboratory identifiers</span>
<span class="sd">    :param distribution: The distribution assumed when assigning Z scores to each measurement of a sample.</span>
<span class="sd">    :returns: z_mask, a Boolean mask that will remove the outliers from the data</span>
<span class="sd">    :returns: zscores_projected</span>
<span class="sd">    :returns: robust_pdf_params, the parameters of the final distribution used to identify the outliers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1">#len(support_fractions)</span>
    <span class="c1">#support_fraction = 0.6</span>
    
    <span class="n">PCAsign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">distance_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">zscores</span><span class="p">,(</span><span class="n">numspecs</span><span class="p">,</span><span class="n">numsets</span><span class="p">))</span>
    <span class="c1">#zscores_projected = zscorepca.transform(distance_scores.T)*PCAsign</span>
    <span class="c1">#zscores_projected = np.exp(zscorepca.transform(np.log(distance_scores.T)*PCAsign))</span>
    
    <span class="n">zscores_projected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="o">*</span><span class="n">PCAsign</span><span class="p">,</span><span class="n">distance_scores</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="c1">#zscores_projected = np.exp(np.dot(zscorepca.components_*PCAsign,np.log(distance_scores)).T)</span>
    
    <span class="c1">#Find those zscore principal components that explain more than 1% of the variance</span>
    <span class="c1">#The robust determinant will include all of those</span>
    <span class="n">zscores_mask</span> <span class="o">=</span> <span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span> <span class="o">&gt;</span> <span class="mf">0.01</span>
    
    <span class="c1">#Force the second principal component to be active</span>
    <span class="n">zscores_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1">#Find the number of active components</span>
    <span class="n">num_active_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">zscores_mask</span><span class="p">)</span>
    
    <span class="c1">#Compute the distance to the origin of each lab to the origin, using only the major components</span>
    <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">num_active_components</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#print norms</span>
    <span class="c1">#Fit the empirical lognormal distribution to the data</span>
    <span class="n">ln_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">norms</span><span class="p">)</span>
    <span class="n">norm_mean</span> <span class="o">=</span> <span class="n">ln_norms</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">norm_scale</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">norm_mean</span><span class="p">)</span>
    <span class="n">norm_std</span> <span class="o">=</span> <span class="n">ln_norms</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span><span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#lognormal_dist = sp.stats.lognorm(norm_std,scale=norm_scale)</span>
    <span class="c1"># Get Z scores for this distribution</span>
    <span class="n">lognormal_int</span> <span class="o">=</span> <span class="n">lognormal_integral</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span><span class="n">norm_std</span><span class="p">,</span><span class="n">norm_mean</span><span class="p">)</span>
    <span class="n">distance_z</span> <span class="o">=</span> <span class="n">lognormal_z</span><span class="p">(</span><span class="n">lognormal_int</span><span class="p">)</span>
    
    <span class="n">lognormal_int</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">norms</span><span class="p">)</span>
    <span class="n">distance_z</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">lognormal_int</span><span class="p">)</span>
    
    <span class="c1">#Statistical calculations will be done on the robust distribution, so start with the robust distribution </span>
    <span class="c1">#being the same as the empirical distribution</span>
    <span class="n">norm_mean_robust</span> <span class="o">=</span> <span class="n">norm_mean</span>
    <span class="n">norm_scale_robust</span> <span class="o">=</span> <span class="n">norm_scale</span>
    <span class="n">norm_std_robust</span> <span class="o">=</span> <span class="n">norm_std</span>
    
    <span class="n">z_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">distance_z</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1">#Set the mask to a True array of the same size as the distance array</span>
    <span class="n">num_inliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">z_mask</span><span class="p">)</span>
    
    <span class="c1">#Maximum number of outliers</span>
    <span class="n">max_num_outliers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">support_fraction</span><span class="p">)</span><span class="o">*</span><span class="n">numsets</span><span class="p">)</span>
    <span class="n">params_robust</span> <span class="o">=</span> <span class="n">params</span>
    
    
    <span class="c1">#Robust lognormal distribution</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_num_outliers</span><span class="p">):</span> <span class="c1"># Do this computation for the number of outliers that we expect</span>
        <span class="c1">#if np.count_nonzero(z_mask) &lt;= support_fraction*10 : #But stop the computation if there are too many outliers</span>
            <span class="c1">#    print i</span>
            <span class="c1">#    print z_mask</span>
            <span class="c1">#    break</span>
        <span class="n">z_max</span> <span class="o">=</span> <span class="n">distance_z</span><span class="p">[</span><span class="n">z_mask</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># Find the maximum Z score among the remaining inliers. This is the candidate outlier.</span>
        
        <span class="k">if</span> <span class="n">z_max</span> <span class="o">&lt;</span> <span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.9495</span><span class="p">):</span> <span class="c1"># Check if the candidate outlier&#39;s Z score is within the current 95% confidence interval </span>
            <span class="c1">#of the current robust distribution. Stop the computation</span>
            <span class="c1">#print i</span>
            <span class="c1">#print z_mask</span>
            <span class="k">break</span> <span class="c1">#</span>
        
        <span class="n">z_mask</span> <span class="o">=</span> <span class="n">distance_z</span> <span class="o">&lt;</span> <span class="n">z_max</span> <span class="c1">#Remove all points with larger Z scores than the current outlier</span>

        <span class="c1">#Calculate the new robust distribution</span>
        <span class="n">norms_robust</span> <span class="o">=</span> <span class="n">norms</span><span class="p">[</span><span class="n">z_mask</span><span class="p">]</span>
        <span class="n">ln_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">norms_robust</span><span class="p">)</span>
        <span class="n">norm_mean_robust</span> <span class="o">=</span> <span class="n">ln_norms</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">norm_scale_robust</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">norm_mean_robust</span><span class="p">)</span>
        <span class="n">norm_std_robust</span> <span class="o">=</span> <span class="n">ln_norms</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        
        <span class="n">lognormal_int</span> <span class="o">=</span> <span class="n">lognormal_integral</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span><span class="n">norm_std_robust</span><span class="p">,</span><span class="n">norm_mean_robust</span><span class="p">)</span>
        <span class="n">distance_z</span> <span class="o">=</span> <span class="n">lognormal_z</span><span class="p">(</span><span class="n">lognormal_int</span><span class="p">)</span>
        
        <span class="n">params_robust</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">norms_robust</span><span class="p">,</span><span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rv_robust</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="o">*</span><span class="n">params_robust</span><span class="p">)</span>
        <span class="n">lognormal_int</span> <span class="o">=</span> <span class="n">rv_robust</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">norms</span><span class="p">)</span>
        <span class="n">distance_z</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">lognormal_int</span><span class="p">)</span>

    <span class="n">robust_pdf_params</span> <span class="o">=</span> <span class="n">params_robust</span><span class="c1">#(norm_std_robust,norm_mean_robust)</span>
    <span class="k">return</span> <span class="n">z_mask</span><span class="p">,</span><span class="n">zscores_projected</span><span class="p">,</span><span class="n">robust_pdf_params</span>

    
    
    
<span class="k">def</span> <span class="nf">zscore_outlier_plots</span><span class="p">(</span><span class="n">z_mask</span><span class="p">,</span><span class="n">zscores_projected</span><span class="p">,</span><span class="n">zscorepca</span><span class="p">,</span><span class="n">robust_pdf_params</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">lab_labels</span><span class="p">,</span><span class="n">distribution</span><span class="p">,</span><span class="n">y_component</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots the principal component scores for each lab along with the final distribution used to calculate the outliers</span>
<span class="sd">    </span>
<span class="sd">    :param z_mask: a Boolean mask that will remove the outliers from the data</span>
<span class="sd">    :param zscores_projected: </span>
<span class="sd">    :param robust_pdf_params: The parameters of the final distribution used to identify the outliers</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param lab_labels: The list of laboratory identifiers</span>
<span class="sd">    :param distribution: The distribution assumed when assigning Z scores to each measurement of a sample.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_plots</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1">#norm_std_robust,norm_mean_robust = robust_pdf_params</span>
    <span class="c1">#If specified, take the logarithm of the first component (it will always be positive)</span>
    <span class="k">if</span> <span class="n">take_log</span><span class="p">:</span>
        <span class="n">zscores_projected</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#Create the first PCA plot to find out how big the contour plot needs to be</span>
    <span class="n">pcaplot</span><span class="p">,</span><span class="n">pca_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#Plot the data to see how big the pdfs need to be</span>
    <span class="c1">#scatterplot = pca_ax.scatter(zscores_projected[:,0],zscores_projected[:,1])</span>
    <span class="n">scatterplot</span> <span class="o">=</span> <span class="n">pca_ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">z_mask</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">z_mask</span><span class="p">,</span><span class="n">y_component</span><span class="p">],</span>
                                 <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">scatterplot</span> <span class="o">=</span> <span class="n">pca_ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">z_mask</span><span class="p">),</span><span class="mi">0</span><span class="p">],</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">z_mask</span><span class="p">),</span><span class="n">y_component</span><span class="p">],</span>
                                 <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span> <span class="o">=</span> <span class="n">pca_ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">pca_ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    
    <span class="c1">#if take_log is False:</span>
    <span class="c1">#    xmin = 0</span>
    <span class="c1">#ymin = 0</span>

    <span class="c1">#Create the plot array</span>
    <span class="c1">#pcaplot,pca_ax = plt.subplots(num_plots,1,figsize = (10,5),sharex=True,sharey=True)</span>
    

    <span class="c1">#Number of points to use to calculate the MH distance contours</span>
    <span class="n">numgrid</span> <span class="o">=</span> <span class="mi">60</span>
    
    <span class="n">xstep</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="n">numgrid</span>
    <span class="n">ystep</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="n">numgrid</span>
    
    <span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">xstep</span><span class="p">)</span>
    <span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">,</span><span class="n">ystep</span><span class="p">)</span>
    
    <span class="c1">#print xdata</span>
    <span class="c1">#print ydata</span>
    
    <span class="c1">#Set up the grid mesh for the contour plots</span>
    <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">)</span>
    
    <span class="c1">#Calculate the distance function for the contour plots</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">take_log</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">yy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="c1">#Calculate the lognormal Z function w.r.t. the distance from the origin</span>
    <span class="c1">#integrals = lognormal_integral(dist,norm_std_robust,norm_mean_robust)</span>
    <span class="c1">#pdf_for_plot = lognormal_z(integrals)</span>
    
    <span class="n">rv</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="o">*</span><span class="n">robust_pdf_params</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">integrals</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">pdf_for_plot</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">integrals</span><span class="p">)</span>
    
    <span class="c1">#pdf_for_plot = qmet.lognormal_z(dist)</span>
    <span class="c1">#pdf_for_plot = lognormal_dist.cdf(dist)</span>
    <span class="c1">#pdf_for_plot = pdf_for_plot/pdf_for_plot.max()</span>
    
    <span class="c1">#Level curves of the lognormal Z function</span>
    <span class="n">levelsc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">levelsf</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    
    <span class="n">levelsc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)))</span> <span class="o">+</span> <span class="p">[</span><span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)]</span>
    <span class="n">levelsf</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">),</span><span class="mf">0.5</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)]</span>
    
    <span class="n">cformats</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;</span><span class="si">{:1.0f}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">levelsc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">cformats</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{:3.1f}</span><span class="s1">&#39;</span><span class="p">]</span>
    
    <span class="n">cformats_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="n">fmt_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">fmt_str</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">levelsc</span><span class="p">,</span><span class="n">cformats</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">ccolors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">levelsc</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ccolors</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">levelsc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1">#print levelsc</span>
    <span class="c1">#print cformats_dict</span>
    <span class="c1">#print ccolors</span>

    
    <span class="c1">#pdf_for_plot = np.sqrt(np.log(pdf_for_plot) * -2)</span>
    
    
    <span class="c1">#print pdf_for_plot</span>
    
    <span class="n">ctr1</span> <span class="o">=</span> <span class="n">pca_ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">pdf_for_plot</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">levelsf</span><span class="p">)</span>
    <span class="c1">#ctr2 = pca_ax.contour(xx,yy,pdf_for_plot,extend=&#39;neither&#39;,cmap=&#39;Blues&#39;,levels=levelsc)</span>
    <span class="c1">#ctr2 = pca_ax.contour(xx,yy,pdf_for_plot,extend=&#39;neither&#39;,colors=(&#39;w&#39;,&#39;w&#39;,&#39;k&#39;,&#39;k&#39;,&#39;k&#39;),levels=levelsc)</span>
    <span class="n">ctr2</span> <span class="o">=</span> <span class="n">pca_ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">pdf_for_plot</span><span class="p">,</span><span class="n">extend</span><span class="o">=</span><span class="s1">&#39;neither&#39;</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="n">ccolors</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">levelsc</span><span class="p">)</span>
    <span class="c1">#plt.colorbar(ctr1,ax=pca_ax)</span>
    <span class="c1">#contourlabels = plt.clabel(ctr2,fmt=&#39;%1.0f&#39;,colors=(&#39;w&#39;,&#39;w&#39;,&#39;k&#39;,&#39;k&#39;,&#39;k&#39;))</span>
    <span class="n">contourlabels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">ctr2</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">cformats_dict</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="n">ccolors</span><span class="p">)</span><span class="c1">#(&#39;w&#39;,&#39;w&#39;,&#39;k&#39;,&#39;k&#39;,&#39;k&#39;))</span>
    <span class="n">scatterplot</span> <span class="o">=</span> <span class="n">pca_ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">z_mask</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">z_mask</span><span class="p">,</span><span class="n">y_component</span><span class="p">],</span>
                                 <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="c1">#scatterplot = pca_ax.scatter(zscores_projected[np.invert(z_mask),0],zscores_projected[np.invert(z_mask),y_component],</span>
    <span class="c1">#                             c=&#39;b&#39;,edgecolors=&#39;none&#39;)</span>
    <span class="c1">#scatterplot = pca_ax.scatter(np.log(zscores_projected[z_mask,0]),zscores_projected[z_mask,1],c=&#39;r&#39;,edgecolors=&#39;none&#39;)</span>
    <span class="c1">#scatterplot = pca_ax.scatter(np.log(zscores_projected[np.invert(z_mask),0]),zscores_projected[np.invert(z_mask),1],c=&#39;b&#39;,edgecolors=&#39;none&#39;)</span>
    <span class="n">pca_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>
    <span class="n">pca_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span>
    
    <span class="n">component1score</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">component2score</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="n">y_component</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">xaxislabel</span> <span class="o">=</span> <span class="s1">&#39;Component 1: &#39;</span> <span class="o">+</span> <span class="n">component1score</span> <span class="o">+</span> <span class="s2">&quot; %&quot;</span>
    <span class="n">yaxislabel</span> <span class="o">=</span> <span class="s1">&#39;Component &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y_component</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">component2score</span> <span class="o">+</span> <span class="s2">&quot; %&quot;</span>
    
    <span class="n">pca_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xaxislabel</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">pca_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">yaxislabel</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">outlier_x_text_position</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">xmin</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">xmax</span>
    <span class="c1">#alpha = 0.5</span>
    <span class="c1">#outlier_y_text_position = (1 - alpha)*ymin + alpha*ymax</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">labeltext</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">z_mask</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
            <span class="n">pca_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span><span class="n">zscores_projected</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">y_component</span><span class="p">],</span>
                        <span class="n">labeltext</span><span class="p">,</span>
                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                        <span class="n">size</span><span class="o">=</span><span class="s1">&#39;9&#39;</span><span class="p">,</span>
                        <span class="n">bbox</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">))</span>
    <span class="c1">#        pca_ax.text(outlier_x_text_position,outlier_y_text_position,</span>
    <span class="c1">#                    labeltext,</span>
    <span class="c1">#                    ha=&#39;left&#39;,va=&#39;top&#39;,</span>
    <span class="c1">#                    size=&#39;9&#39;)</span>
    <span class="c1">#        alpha = alpha - 0.1</span>
    <span class="c1">#        outlier_y_text_position = (1 - alpha)*ymin + alpha*ymax</span>
    <span class="k">return</span> <span class="n">pcaplot</span>
<span class="k">def</span> <span class="nf">zscore_projected_plot</span><span class="p">(</span><span class="n">zscoreax</span><span class="p">,</span><span class="n">zscorepca</span><span class="p">,</span><span class="n">zscores_projected</span><span class="p">,</span><span class="n">z_mask</span><span class="p">,</span><span class="n">robust_pdf_params</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">lab_labels</span><span class="p">,</span><span class="n">distribution</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots the projected statistical distances and the corresponding lab-level Z scores </span>
<span class="sd">    </span>
<span class="sd">    :param zscoreax: The axis that the statistical distances will be plotted on</span>
<span class="sd">    :param z_mask: a Boolean mask that will remove the outliers from the data</span>
<span class="sd">    :param zscores_projected: </span>
<span class="sd">    :param robust_pdf_params: The parameters of the final distribution used to identify the outliers</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param lab_labels: The list of laboratory identifiers</span>
<span class="sd">    :param distribution: The distribution assumed when assigning Z scores to each measurement of a sample.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1">#Specify the active components as those that explain more than 1% of the total variance</span>
    <span class="n">zscores_mask</span> <span class="o">=</span> <span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span> <span class="o">&gt;</span> <span class="mf">0.01</span>
    <span class="n">zscores_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Force component 2 to be active</span>
    <span class="n">num_active_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">zscores_mask</span><span class="p">)</span>
    
    <span class="c1">#Calculate the norms of the projected z-score vectors</span>
    <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">zscores_projected</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">num_active_components</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#Recover the robust PDF of the projected z-score distribution and calculate the aggregate z-scores</span>
    <span class="c1">#(norm_std_robust,norm_mean_robust) = robust_pdf_params</span>
    <span class="c1">#distribution = sp.stats.lognorm</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="o">*</span><span class="n">robust_pdf_params</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">distribution</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">quantile</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">norms</span><span class="p">)</span>
    <span class="c1">#quantile[quantile &gt; 0.99999999] = 0.99999999</span>
    <span class="c1">#print quantile</span>
    
    <span class="n">distance_z</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">quantile</span><span class="p">)</span><span class="c1">#rv.cdf(norms))</span>
    
    <span class="k">if</span> <span class="n">distribution</span> <span class="ow">is</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">:</span>
        <span class="n">norm_mean_robust</span> <span class="o">=</span> <span class="n">robust_pdf_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">norm_std_robust</span> <span class="o">=</span> <span class="n">robust_pdf_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">distance_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">norms</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">norm_mean_robust</span><span class="p">))</span> <span class="o">/</span> <span class="n">norm_std_robust</span><span class="p">)</span>
    
    <span class="c1">#qprintstr = &#39;{:4.5f}&#39;#&#39;{&#39; + &#39;:3.1f &#39; * numsets + &#39;}&#39;</span>
    <span class="c1">#print qprintstr</span>
    <span class="c1">#print robust_pdf_params</span>
    <span class="c1">#print &quot; &quot;.join(qprintstr.format(q) for q in quantile)</span>
    <span class="c1">#print qprintstr.format(tuple(map(tuple,quantile)))</span>
    
    <span class="c1">#</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.4</span>
    
    <span class="c1">#Default bar colors and text box transparency</span>
    <span class="n">bar_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
    <span class="n">bar_edge</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
    <span class="n">box_trans</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
    <span class="k">for</span> <span class="n">int_num</span><span class="p">,</span><span class="n">z_out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z_mask</span><span class="p">):</span>
        <span class="c1">#Color and transparency if the point is an outlier</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">z_out</span><span class="p">):</span>
            <span class="n">bar_colors</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="n">bar_edge</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="n">box_trans</span><span class="p">[</span><span class="n">int_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#zscoreax.bar(np.arange(numsets)-width,norms,2*width,alpha=1,color=bar_colors)</span>
    <span class="n">zscoreax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">),</span><span class="n">norms</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">bar_colors</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">bar_edge</span><span class="p">)</span>
    
    <span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">zscoreax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    
    <span class="n">sample_label_pos</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">ymax</span> <span class="o">+</span> <span class="mf">0.95</span><span class="o">*</span><span class="n">ymin</span>
    
    <span class="k">for</span> <span class="n">int_num</span><span class="p">,</span><span class="n">zscore</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">distance_z</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">z_mask</span><span class="p">[</span><span class="n">int_num</span><span class="p">]):</span> 
            <span class="n">label_pos</span> <span class="o">=</span> <span class="n">sample_label_pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">norms</span><span class="p">[</span><span class="n">int_num</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_pos</span> <span class="o">=</span> <span class="n">sample_label_pos</span>
    
        <span class="n">zscoreax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">int_num</span><span class="p">,</span><span class="n">label_pos</span><span class="p">,</span>
                      <span class="nb">str</span><span class="p">(</span><span class="n">zscore</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span>
                      <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                      <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">box_trans</span><span class="p">[</span><span class="n">int_num</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                     <span class="p">)</span>
    <span class="n">zscoreax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">numsets</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">zscoreax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numsets</span><span class="p">))</span>
    <span class="n">zscoreax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="k">return</span>
<span class="k">def</span> <span class="nf">zscore_loadings_bar</span><span class="p">(</span><span class="n">loadax</span><span class="p">,</span><span class="n">zscorepca</span><span class="p">,</span><span class="n">positional_array</span><span class="p">,</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">lab_labels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots the PCA loadings calculated using zscore_principal_components()</span>
<span class="sd">    </span>
<span class="sd">    :param zscoreax: The axis that the PCA loadings will be plotted on</span>
<span class="sd">    :param zscorepca: The principal components calculated using zscore_principal_components()</span>
<span class="sd">    :param positional_array: The array defining the structure of the data matrix</span>
<span class="sd">    :param Spectrum_names: The list of sample names</span>
<span class="sd">    :param lab_labels: The list of laboratory identifiers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numsets</span> <span class="o">=</span> <span class="n">positional_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">numspecs</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1">#width = 5</span>
    <span class="c1">#loadfig,loadax = plt.subplots(figsize=(numcols*width,numrows+1),sharex=True,sharey=True)</span>
    <span class="n">PCAsign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
    <span class="n">zscores_mask</span> <span class="o">=</span> <span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span> <span class="o">&gt;</span> <span class="mf">0.01</span>
    <span class="n">zscores_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">num_active_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">zscores_mask</span><span class="p">)</span>
    
    <span class="c1">#Calculate the positions where the bars will go</span>
    <span class="n">total_width</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">total_width</span><span class="o">/</span><span class="n">num_active_components</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">total_width</span><span class="p">,</span><span class="n">total_width</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">width</span><span class="p">)</span>
    
    <span class="c1">#Create the spectrum of colors that will be used for the plot</span>
    <span class="n">bar_properties</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">num_active_components</span><span class="p">)</span>
    
    <span class="c1">#bar_colors = [&#39;w&#39;] * numsets</span>
    <span class="n">bar_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
    <span class="n">text_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
    <span class="n">box_trans</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
    <span class="c1">#Plot the principal components</span>
    <span class="k">for</span> <span class="n">component_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_active_components</span><span class="p">):</span>
        <span class="c1">#intensity = bar_properties[component_num]</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="n">component_num</span><span class="p">]</span>
        <span class="c1">#bar_colors = [[intensity] * 2 + [1]] * numsets</span>
        <span class="n">bar_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="n">intensity</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">numsets</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">component_num</span><span class="p">]</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">loadax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numspecs</span><span class="p">)</span><span class="o">+</span><span class="n">position</span><span class="p">,</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="n">component_num</span><span class="p">,:]</span><span class="o">*</span><span class="n">PCAsign</span><span class="p">,</span>
                        <span class="mi">2</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">bar_colors</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="c1">#bar_colors = [&#39;b&#39;] * numsets</span>
    <span class="c1">#im = loadax.bar(np.arange(numspecs)-width,zscorepca.components_[1,:]*PCAsign,2*width,alpha=0.7,color=bar_colors)</span>
    <span class="c1">#bar_colors = [&#39;c&#39;] * numsets</span>
    <span class="c1">#im = loadax.bar(np.arange(numspecs)-width,zscorepca.components_[2,:]*PCAsign,2*width,alpha=0.3,color=bar_colors)</span>
    <span class="c1">#im = loadax.imshow(zscorepca.components_*PCAsign,interpolation=&quot;none&quot;,cmap=&quot;seismic&quot;,vmin=-1,vmax=1)</span>
    <span class="c1">#loadbar = loadfig.colorbar(im,ax=loadax)#,orientation=&#39;horizontal&#39;)</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">numspecs</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">numspecs</span><span class="p">))</span>
    <span class="n">loadax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">loadax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    
    <span class="c1">#loadax.set_xlabel(&#39;Sample ID&#39;,size=15)</span>
    <span class="c1">#loadax.set_xlabel(&#39;Principal Component Number&#39;,size=15)</span>
    <span class="c1">#loadbar.set_label(&#39;Component Value&#39;,size=15)</span>
    
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span><span class="o">+</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span><span class="o">-</span><span class="n">ymax</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">num_active_components</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymax</span><span class="o">+</span><span class="n">interval</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">interval</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">component_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_active_components</span><span class="p">):</span>
        <span class="n">componenet_label_position</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">component_number</span><span class="p">]</span>
        <span class="n">componentscore</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%5.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zscorepca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="n">component_number</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">componentscore_string</span> <span class="o">=</span> <span class="n">componentscore</span> <span class="o">+</span> <span class="s2">&quot; %&quot;</span>
        <span class="n">loadax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">numspecs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="n">componenet_label_position</span><span class="p">,</span><span class="n">componentscore_string</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span><span class="c1">#,bbox=dict(facecolor=&#39;white&#39;))</span>
        <span class="c1">#loadax.text(numspecs,component_number,componentscore_string,ha=&#39;center&#39;,va=&#39;center&#39;,bbox=dict(facecolor=&#39;white&#39;))</span>
    <span class="k">return</span>
<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../Project.html#qmet.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The top-level project class for the interlaboratory comparison module</span>
<span class="sd">    </span>
<span class="sd">    :param distance_metric_dict: The dictionary of distance metrics that will be used to detect outliers. Outliers will be detected separately for each distance function</span>
<span class="sd">    :param Sample_names: The list of sample names. Each sample must have its own name</span>
<span class="sd">    :param Data_set_names: The list of data sets in the interlaboratory comparison</span>
<span class="sd">    :param x_data_list: The list of x data in the data array. For NMR, this will be an array of chemical shifts</span>
<span class="sd">    :param range_to_use: Which data from the spectrum will actually be used. If None, do not remove any data</span>
<span class="sd">    :param distribution_function: Which distribution will be assumed when assigning Z scores to each measurement of a sample. The default is sp.stats.lognorm</span>
<span class="sd">    :param outlier_dist: Which distribution will be assumed when detecting outliers. The default is the same as distribution_function</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data_loader</span><span class="o">=</span><span class="n">fanndataread</span><span class="p">,</span>
                 <span class="n">distance_metric_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">Sample_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">Data_set_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">x_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">range_to_use</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">distribution_function</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">,</span>
                 <span class="n">outlier_dist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="c1"># Feature data and corresponding bin name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_loader</span> <span class="o">=</span> <span class="n">data_loader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_data_list</span><span class="p">)</span>
        
        <span class="c1"># Names for the data sets (or laboratories) and samples ()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Labels</span> <span class="o">=</span> <span class="n">Data_set_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span> <span class="o">=</span> <span class="n">Sample_names</span>
        
        <span class="c1">#Array that defines the positions of the arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span> <span class="o">=</span> <span class="n">positional_array</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">))</span>
        
        <span class="c1">#Range of data to use for analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_range_to_use</span> <span class="o">=</span> <span class="n">range_to_use</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span> <span class="o">=</span> <span class="n">distance_metric_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_matrix</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_matrix_bylab</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distances</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mahalanobis_dict</span> <span class="o">=</span> <span class="kc">None</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">zscores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projected_zscores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_mask</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zscore_pdf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distribution_function</span> <span class="o">=</span> <span class="n">distribution_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outlier_distribution</span> <span class="o">=</span> <span class="n">outlier_dist</span>
        <span class="k">if</span> <span class="n">outlier_dist</span> <span class="ow">is</span>  <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outlier_distribution</span> <span class="o">=</span> <span class="n">distribution_function</span>
        <span class="k">return</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param data_file: The data file that is passed to qmet.fanndataread</span>
<span class="sd">        :type data_file: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
    
    <span class="nd">@data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data_source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param data_file: The data file that is passed to qmet.fanndataread</span>
<span class="sd">        :type data_file: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">project_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_loader</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span>
        
        <span class="n">features</span> <span class="o">=</span> <span class="n">project_data</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range_to_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">_range_to_use</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_x_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_range_to_use</span><span class="p">]</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">fix_spectrum</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">features</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">features</span>
        <span class="k">return</span>
    
    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">max_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">plot_increment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
        <span class="n">spectrumplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span><span class="n">increment</span><span class="o">=</span><span class="n">plot_increment</span><span class="p">,</span><span class="n">vertsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">maxz</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mf">35.0</span><span class="p">,</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">xdata</span><span class="o">=-</span><span class="mi">1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_data</span><span class="p">)</span>
    
<div class="viewcode-block" id="Project.set_distances"><a class="viewcode-back" href="../Project.html#qmet.Project.set_distances">[docs]</a>    <span class="k">def</span> <span class="nf">set_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the interspectral distances for each metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">distance_metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="n">metric_function</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_distance_matrix</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span><span class="n">metric_function</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">set_distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">,</span><span class="n">metric_function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">metric_function</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">metric_function</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_matrix_bylab</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">distances</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                                                                                      <span class="n">metric_function</span><span class="p">,</span>
                                                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span>
                                                                                      <span class="bp">self</span><span class="o">.</span><span class="n">mahalanobis_dict</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="k">def</span> <span class="nf">process_mahalanobis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the Mahalanobis distance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mahalanobis_dict</span> <span class="o">=</span> <span class="n">mahalanobis_covariance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span>
    
<div class="viewcode-block" id="Project.set_zscores"><a class="viewcode-back" href="../Project.html#qmet.Project.set_zscores">[docs]</a>    <span class="k">def</span> <span class="nf">set_zscores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the sample-level Z scores for each metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">distance_metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_zscore_matrix</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span></div>
        
    <span class="k">def</span> <span class="nf">set_zscore_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_zscores</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_distribution_function</span>
                                                                                   <span class="p">)</span>
        <span class="k">return</span>
    
<div class="viewcode-block" id="Project.set_zscore_principal_components"><a class="viewcode-back" href="../Project.html#qmet.Project.set_zscore_principal_components">[docs]</a>    <span class="k">def</span> <span class="nf">set_zscore_principal_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the principal components analysis on the sample-level Z scores</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">distance_metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_pca</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">set_pca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">zscore_principal_components</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span>
        <span class="p">)</span>
    
<div class="viewcode-block" id="Project.find_all_outliers"><a class="viewcode-back" href="../Project.html#qmet.Project.find_all_outliers">[docs]</a>    <span class="k">def</span> <span class="nf">find_all_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the laboratory-outliers for each metric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">distance_metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_outliers</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span></div>
        
    <span class="k">def</span> <span class="nf">find_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
        <span class="n">support_fraction</span> <span class="o">=</span> <span class="mf">0.6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_mask</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">projected_zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">zscore_pdf</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">zscore_outliers</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="n">support_fraction</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_outlier_distribution</span>
            <span class="p">)</span>
        
    
<div class="viewcode-block" id="Project.plot_distance_fig"><a class="viewcode-back" href="../Project.html#qmet.Project.plot_distance_fig">[docs]</a>    <span class="k">def</span> <span class="nf">plot_distance_fig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plot_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span><span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">distance_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For each sample, generates the following plots:</span>
<span class="sd">        * A plot of the spectra generated for that sample by each laboratory</span>
<span class="sd">        * For each metric, a heat map plot of the interspectral distance matrix</span>
<span class="sd">        </span>
<span class="sd">        :key plot_range: An iterable of integers specifying which sample labels to plot</span>
<span class="sd">        :key cmap: The color map that will be used for the distance heat maps</span>
<span class="sd">        :key linecolor: The line color that will be used for the spectral data</span>
<span class="sd">        :key distance_metrics: A list of the distance metrics for which heat maps will be plotted. If None, plot heat maps for all metrics in this project</span>
<span class="sd">        :returns: distance_fig, the distance measure figure matplotlib object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">distance_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">distance_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span><span class="p">]</span>
        
        <span class="n">distance_matrix_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">distance_metrics</span><span class="p">]</span>
        <span class="c1">#distance_name_list = [metric[&#39;metric&#39;] for metric in self.distance_metrics]</span>
        <span class="c1">#distance_matrix_list = [self.distance_matrix[metric] for metric in distance_name_list]</span>
        
        <span class="k">if</span> <span class="n">plot_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">plot_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">distance_fig</span> <span class="o">=</span> <span class="n">distance_measure_fig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_data</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="n">plot_range</span><span class="p">,</span>
                                            <span class="n">distance_matrix_list</span><span class="p">,</span><span class="n">distance_metrics</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">linecolor</span><span class="o">=</span><span class="n">linecolor</span>
                                           <span class="p">)</span>
        <span class="k">return</span> <span class="n">distance_fig</span></div>
    
<div class="viewcode-block" id="Project.plot_zscore_distances"><a class="viewcode-back" href="../Project.html#qmet.Project.plot_zscore_distances">[docs]</a>    <span class="k">def</span> <span class="nf">plot_zscore_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">,</span><span class="n">plot_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">numcols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plots a bar chart of the average interspectral distance for each sample, annotated with the generalized Z score for each sample</span>
<span class="sd">        </span>
<span class="sd">        :param metrics: The metric for which the distances will be plotted</span>
<span class="sd">        :key plot_range: An iterable of integers specifying which sample labels to plot</span>
<span class="sd">        :key numcols: The number of columns in the distance plot</span>
<span class="sd">        :returns zscore_distances_fig: The distances and scores plot as a matplotlib figure object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zscore_distances_fig</span> <span class="o">=</span> <span class="n">plot_zscores</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">,</span>
                                            <span class="n">num_bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">plot_range</span><span class="o">=</span><span class="n">plot_range</span><span class="p">,</span><span class="n">numcols</span><span class="o">=</span><span class="n">numcols</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="n">metric</span>
                                           <span class="p">)</span>
        <span class="k">return</span> <span class="n">zscore_distances_fig</span></div>
    
<div class="viewcode-block" id="Project.plot_distance_histograms"><a class="viewcode-back" href="../Project.html#qmet.Project.plot_distance_histograms">[docs]</a>    <span class="k">def</span> <span class="nf">plot_distance_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">,</span><span class="n">plot_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">numcols</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots a histogram of the average interspectral distance for each sample, along with the corresponding fit</span>
<span class="sd">        </span>
<span class="sd">        :param metrics: The metric for which the distances will be plotted</span>
<span class="sd">        :key plot_range: An iterable of integers specifying which sample labels to plot</span>
<span class="sd">        :key numcols: The number of columns in the distance plot</span>
<span class="sd">        :returns zscore_distances_fig: The distances and scores plot as a matplotlib figure object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distance_histograms_fig</span> <span class="o">=</span> <span class="n">plot_histograms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_distribution_function</span><span class="p">,</span>
                                                  <span class="n">num_bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">plot_range</span><span class="o">=</span><span class="n">plot_range</span><span class="p">,</span><span class="n">numcols</span><span class="o">=</span><span class="n">numcols</span>
                                                 <span class="p">)</span>
        <span class="k">return</span> <span class="n">distance_histograms_fig</span></div>
        
    <span class="k">def</span> <span class="nf">plot_zscore_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
        <span class="n">zscore_heatmap</span> <span class="o">=</span> <span class="n">zscore_heatmap_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zscore_heatmap</span>
        
    <span class="k">def</span> <span class="nf">plot_zscore_loadings_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">):</span>
        <span class="n">zscore_loadings_heatmap</span> <span class="o">=</span> <span class="n">zscore_loadings_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zscore_loadings_heatmap</span>
    
<div class="viewcode-block" id="Project.plot_zscore_outliers"><a class="viewcode-back" href="../Project.html#qmet.Project.plot_zscore_outliers">[docs]</a>    <span class="k">def</span> <span class="nf">plot_zscore_outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metric</span><span class="p">,</span><span class="n">y_component</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots the principal component scores for each lab along with the final distribution used to calculate the outliers</span>
<span class="sd">        </span>
<span class="sd">        :param metric: The metric used to calculate the interspectral distances</span>
<span class="sd">        :param y_component: Which principal component to use on the Y axis, if not the first</span>
<span class="sd">        :returns: zscore_outliers_fig, the Z score outlier plot as a matplotlib figure object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zscore_outliers_fig</span> <span class="o">=</span> <span class="n">zscore_outlier_plots</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outlier_mask</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">projected_zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">zscore_pdf</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_outlier_distribution</span><span class="p">,</span><span class="n">y_component</span><span class="o">=</span><span class="n">y_component</span><span class="p">)</span>
        
        <span class="n">zscore_outliers_fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.85</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="n">metric</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">zscore_outliers_fig</span></div>
    
<div class="viewcode-block" id="Project.plot_projected_zscores"><a class="viewcode-back" href="../Project.html#qmet.Project.plot_projected_zscores">[docs]</a>    <span class="k">def</span> <span class="nf">plot_projected_zscores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">distance_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots the projected statistical distances annotated with the corresponding laboratory-level Z scores.</span>
<span class="sd">        </span>
<span class="sd">        :key distance_metrics: A list of the distance metrics for which statistical distances will be plotted. If None, plot statistical distances for all metrics in this project</span>
<span class="sd">        :returns: zscorefig, the projected statistical distances plot as a matplotlib figure object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">distance_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">distance_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">distance_metrics</span><span class="p">:</span>
                <span class="n">metrics_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]]</span>
            <span class="n">distance_metrics</span> <span class="o">=</span> <span class="n">metrics_list</span>
        
        <span class="n">numplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">distance_metrics</span><span class="p">)</span>
        <span class="n">numcols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">numrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">numplots</span> <span class="o">+</span> <span class="n">numcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="n">numcols</span><span class="p">))</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">zscorefig</span><span class="p">,</span><span class="n">zscoreax_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">numrows</span><span class="p">,</span><span class="n">numcols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">numcols</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">numrows</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numplots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">zscoreax</span> <span class="o">=</span> <span class="n">zscoreax_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zscoreax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">zscoreax_array</span><span class="p">])</span>
        
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">r&quot;Projected Statistical Distance, $||T_L||$&quot;</span>
        <span class="k">if</span> <span class="n">numplots</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">zscorefig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ylabel</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">multialignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">zscorefig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.00</span><span class="p">,</span><span class="s1">&#39;Data set ID&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        
        
        
        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span><span class="n">distance_metric</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zscoreax</span><span class="p">,</span><span class="n">distance_metrics</span><span class="p">):</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="n">zscore_projected_plot</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">projected_zscores</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">outlier_mask</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">zscore_pdf</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_outlier_distribution</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span><span class="n">distance_metric</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zscoreax</span><span class="p">,</span><span class="n">distance_metrics</span><span class="p">):</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">metric_label_pos</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">ymin</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">ymax</span>
            <span class="c1">#axis.text(0,metric_label_pos,metric,ha=&#39;left&#39;, va=&#39;center&#39;)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="c1">#print metric_label_pos</span>
            <span class="n">axis_locator</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">prune</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">axis_locator</span><span class="p">)</span>
        <span class="n">zscorefig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">zscorefig</span></div>
<div class="viewcode-block" id="Project.plot_zscore_loadings"><a class="viewcode-back" href="../Project.html#qmet.Project.plot_zscore_loadings">[docs]</a>    <span class="k">def</span> <span class="nf">plot_zscore_loadings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">distance_metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots the principal component loadings for the statistical distances</span>
<span class="sd">        </span>
<span class="sd">        :key distance_metrics: A list of the distance metrics for which loadings will be plotted. If None, plot loadings for all metrics in this project</span>
<span class="sd">        :returns: loadfig, the projected statistical loadings plot as a matplotlib figure object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">distance_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">distance_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">distance_metrics</span><span class="p">:</span>
                <span class="n">metrics_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_metrics</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]]</span>
            <span class="n">distance_metrics</span> <span class="o">=</span> <span class="n">metrics_list</span>
        
        <span class="n">numplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">distance_metrics</span><span class="p">)</span>
        <span class="n">numcols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">numrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">numplots</span> <span class="o">+</span> <span class="n">numcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="n">numcols</span><span class="p">))</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">loadfig</span><span class="p">,</span><span class="n">loadax_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">numrows</span><span class="p">,</span><span class="n">numcols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">numcols</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="n">numrows</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numplots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">loadax</span> <span class="o">=</span> <span class="n">loadax_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loadax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">loadax_array</span><span class="p">])</span>
        <span class="n">loadfig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="s2">u&quot;Component Value&quot;</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">loadfig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.00</span><span class="p">,</span><span class="s1">&#39;Cluster ID&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span><span class="n">distance_metric</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">loadax</span><span class="p">,</span><span class="n">distance_metrics</span><span class="p">):</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="n">zscore_loadings_bar</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_positional_array</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">Spectrum_names</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">Labels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span><span class="n">distance_metric</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">loadax</span><span class="p">,</span><span class="n">distance_metrics</span><span class="p">):</span>    
            <span class="n">metric</span> <span class="o">=</span> <span class="n">distance_metric</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span>
            <span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">metric_label_pos</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">ymin</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">ymax</span>
            <span class="c1">#axis.text(0.5,metric_label_pos,metric,ha=&#39;left&#39;, va=&#39;center&#39;)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="c1">#print metric_label_pos</span>
            <span class="n">axis_locator</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">prune</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">axis_locator</span><span class="p">)</span>
        <span class="n">loadfig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loadfig</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Project.html">The qMET Project class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analysis_demo.html">Example usage and output</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="../search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="../genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>